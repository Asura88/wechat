#  android中的UAF漏洞分析

原创 编码安全 [ 编码安全 ](javascript:void\(0\);)

**编码安全** ![]()

微信号 bianma2021

功能介绍 专注于编程安全技术的分享。

____

___发表于_

收录于合集 #移动安全 4个



背景  

在线上跑的APP项目，再bugly系统上出现一些闪退的异常信息，通过在一些快测平台测试，发现出现异常点是在某SO的C、C++代码中，出现的问题是UAF的异常。

UAF是释放重引用的内存问题，它不局限于某个开发语言，在于编码过程中出现安全性问题。

下面就对UAF这种漏洞做下整理分析。

UAF理论  



UAF(Use After Free)就是当一个内存块被释放之后再次被使用。

UAF漏洞就是使用已经被释放的内容，从而导致内存奔溃或任意代码执行。

主要详细的两种表现：

1、内存块被释放后，其对于的指针被设置为NULL，然后再次使用，程序就出现崩溃；

2、内存块被释放后，其对应的指针没有被设置为NULL，再下一次被使用之前，没有代码对这块内存块进行修改，程序可能可以正常运转、可能出现奇怪的问题。

程序中使用到悬挂指针指向的数据(已释放的对象)，用于执行指令或作为索引地址去执行，就有可能导致任意代码执行。

大多数时候，UAF漏洞会只会导致信息泄漏，但有的时候，它还可能导致代码执行——攻击者对这种情况更感兴趣。



实践分析  

UAF漏洞：利用内存分配的特性操作分配的已释放使用过的内存块。

换句话说，如果发生如下所示的3个步骤，就会出现UAF漏洞：

（1）分配一个内存区并且让一个指针指向它。

（2）内存区被释放，但原来的指针仍然可用。

（3）使用该指针访问先前释放的内存区。

如果原有的漏洞程序引用到悬挂指针指向的数据，用于执行指令或作为索引地址去执行，就有可能导致任意代码执行，前提是用可控数据去“占坑”已释放的对象.

![]()

上面C语言代码中可以看到buf1这个已经被释放了(free)，在后面通过拷贝函数(strncpy)函数对buf1进行赋值，发现buf2也被赋值了。这既是比较典型的UAF问题。

同样在C++中，假如当类A被释放后，攻击者立刻在原来A所在的内存区上建立一个类B的时候(类继承)，就经常出现这种漏洞。这样的话，当调用类A的方法的时候，实际上执行的是攻击者加载到类B中的代码。

小结  

检测uaf漏洞需要主要通过二进制代码也就是汇编代码指令进行分析。

二进制代码(IDA工具)的分析方法主要有两种：静态分析和动态分析。就目前来说，动态地分析整个代码是非常困难的，因为要想生成可以覆盖所有二进制代码执行路径的输入的话，绝不是一件容易的事情。因此，当我们专注于代码覆盖问题时，静态分析方法似乎更为适用。

 **通过去跟踪所有已经释放的内存堆区域，并且在每次使用指针时都会检查它是否指向这些已经释放的内存区。**

当项目中的代码出现uaf漏洞那么就会导致任意读写的问题。在项目的整个流程中可以通过一些项目制定标准流程：项目发布前做代码评审、功能做黑盒和白盒测试；项目发布后及时做好项目的监控；项目发布问题后及时做好应急预案。通过这些流程包括去降低代码安全性而导致项目问题。

从C、C++代码角度上看，特别是在malloc、new对于的free和delete匹配上特别需要将释放后的指针对象进行做置空操作；在C++中更建议通过使用智能指针可以降低这方面的安全问题。

结束  
参考链接：https://blog.csdn.net/weixin_41487541/article/details/128395445https://blog.csdn.net/qq_40827990/article/details/86320842http://cn-
sec.com/archives/246440.html

预览时标签不可点

微信扫一扫  
关注该公众号

[知道了](javascript:;)

微信扫一扫  
使用小程序

****

[取消](javascript:void\(0\);) [允许](javascript:void\(0\);)

****

[取消](javascript:void\(0\);) [允许](javascript:void\(0\);)

： ， 。   视频 小程序 赞 ，轻点两下取消赞 在看 ，轻点两下取消在看

